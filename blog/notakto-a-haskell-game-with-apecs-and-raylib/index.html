<!doctype html>
<html lang="en">
  <head>
    <!-- Metadata -->
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Notakto: A Haskell game with Apecs and Raylib">
    <meta property="og:description" content="My previous post on Apecs was very well received, but I've seen a lot of people using the now-out-of-date code and somewhat struggling. Time to dive back in!">
    <meta property="og:url" content="https://aas.sh/blog/notakto-a-haskell-game-with-apecs-and-raylib/">
    <meta property="og:image" content="https://res.cloudinary.com/aas-sh/image/upload/v1668980383/blog/2022/11/logo_dctghd.png">
    <title>Notakto: A Haskell game with Apecs and Raylib</title>

    <!-- Favicons -->
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="../../rss.xml">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="../../atom.xml">
    <link rel="apple-touch-icon" sizes="180x180" href="../../assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../assets/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="../../assets/images/favicon/site.webmanifest">

    <!-- Style -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/thirdparty/line-awesome/css/line-awesome.min.css">
    <link rel="stylesheet" href="../../assets/thirdparty/swiperjs/swiper-bundle.min.css">

    

    <!-- Important JS that needs to be loaded up front -->
    <script src="../../assets/scripts/init-darkmode.js"></script>
    <script src="../../assets/thirdparty/swiperjs/swiper-bundle.min.js"></script>
    

  </head>

  <body>
    <nav id="navbar-container">
  <div class="container is-mobile is-max-desktop">
    <div class="columns is-mobile">

      <div class="column nav-section has-text-left">
        <a id="nav-menu-trigger" class="icon-text">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="square" stroke-linejoin="miter" stroke-width="1.5" d="M4 6h20 M4 12h20 M4 18h20"></path>
            </svg>
          </span>
          <span class="is-uppercase is-size-7">Menu</span>
        </a>
      </div>

      <div class="column nav-section has-text-centered">
        <a href="../../">
          <span class="is-size-7">aas.sh</span>
        </a>
      </div>

      <div class="column nav-section has-text-right">
        
          <a id="nav-toc-trigger">
            <span class="mr-2 is-uppercase is-size-7">
              <span class="mobile">Content</span>
              <span class="desktop">Table of Contents</span>
            </span>
          </a>
        

        <span class="theme-toggle ml-2 my-auto">
          <button id="theme-toggle-light" type="button" class="hidden">
            <i class="lar la-moon is-clickable"></i>
          </button>
          <button id="theme-toggle-dark" type="button" class="hidden">
            <i class="lar la-sun is-clickable"></i>
          </button>
        </span>
      </div>

    </div>
  </div>

  <div id="nav-menu" class="container is-max-widescreen apply-shadow">
    <div class="columns">
      <div class="column">
        <ul>
          <a href="../../"><li class="is-uppercase">Home</li></a>
          <li><a href="../../about/">About</a></li>
          <li><a href="../../archive/">Archive</a></li>
          <li><hr></li>
          <li>
            <div>
  <a class="p-1" href="mailto:contact@aas.sh"><i class="las la-envelope-open-text"></i></a>
  <a class="p-1" href="https://linkedin.com/in/itsashe"><i class="lab la-linkedin-in"></i></a>
  <a class="p-1" href="https://github.com/ashe"><i class="lab la-github"></i></a>
  <a class="p-1" href="https://instagram.com/theofficialashe"><i class="lab la-instagram"></i></a>
</div>

          </li>
        </ul>
      </div>
      <div class="column">
        <ul>
          <a href="../../projects/"><li class="is-uppercase">Projects</li></a>
          <li><a href="../../projects/">All Projects</a></li>
          <li><a href="../../posts-by-project/">Posts By Project</a></li>
          <li><hr></li>
          <li class="items-center">
            <i class="las la-snowflake"></i>
            <a href="https://github.com/ashe/dotfiles">
              NixOS Config
            </a>
          </li>
        </ul>
      </div>
      <div class="column">
        <ul>
          <a href="../../blog/"><li class="is-uppercase">Blog</li></a>
          <li><a href="../../blog/">All Posts</a></li>
          <li>
            <i class="las la-rss"></i>
            <a href="../../rss.xml">RSS</a>
            <a href="../../atom.xml">Atom</a>
          </li>
          <li><hr></li>
          <li>
            <i class="las la-code-branch"></i>
            Current rev.: 
            <a href="https://github.com/ashe/ashe.github.io/commit/871ce24">
              871ce24: Updated swiper sha
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  
    <div id="nav-toc" class="table-of-contents">
      <ul class><li><a href="#previously-on-apecs">Previously on Apecs</a></li><li><a href="#about-this-post">About this post</a></li><li><a href="#introduction">Introduction</a><ul class><li><a href="#what-is-the-ecs-pattern">What is the ECS pattern?</a></li><li><a href="#what-is-raylib">What is Raylib?</a></li><li><a href="#what-is-notakto">What is Notakto?</a></li></ul></li><li><a href="#getting-started">Getting started</a><ul class><li><a href="#initial-commit">Initial commit</a></li><li><a href="#introducing-libraries">Introducing libraries</a></li><li><a href="#single-file-example">Single file example</a><ul class><li><a href="#imports-options-and-extensions">Imports, options and extensions</a></li><li><a href="#creating-and-initialising-a-world">Creating and initialising a World</a></li><li><a href="#updating-and-rendering">Updating and rendering</a></li></ul></li></ul></li><li><a href="#visualising-the-state-of-the-game">Visualising the state of the game</a><ul class><li><a href="#what-should-be-an-entity">What should be an entity?</a></li><li><a href="#the-types-module">The Types module</a></li><li><a href="#the-boardcomponent">The BoardComponent</a></li><li><a href="#rendering">Rendering</a></li><li><a href="#multiple-boards">Multiple boards</a></li><li><a href="#board-state">Board state</a></li></ul></li><li><a href="#making-moves">Making moves</a><ul class><li><a href="#preparing-the-raycast">Preparing the raycast</a></li><li><a href="#identifying-the-looked-at-cell">Identifying the looked-at cell</a></li><li><a href="#placing-crosses-dynamically">Placing crosses dynamically</a></li><li><a href="#killing-boards">Killing boards</a></li><li><a href="#restarting-the-game">Restarting the game</a></li><li><a href="#making-players-take-turns">Making players take turns</a></li><li><a href="#bonus-manually-implementing-first-person-camera">Bonus: Manually implementing first-person camera</a></li></ul></li><li><a href="#wrapping-up">Wrapping up</a></li></ul>
    </div>
  

</nav>


    <main class="my-4">
      <section>
  

  <div id="article-hero" class="container">
    <div class="inner apply-shadow">
      
        <div class="swiper featured-swiper">
          <div class="swiper-wrapper">
            
              <div class="swiper-slide">
                <img src="https://res.cloudinary.com/aas-sh/image/upload/v1668980383/blog/2022/11/logo_dctghd.png" alt="Featured image 0 for Notakto: A Haskell game with Apecs and Raylib">
              </div>
            
              <div class="swiper-slide">
                <img src="https://res.cloudinary.com/aas-sh/image/upload/v1668977503/blog/2022/11/20-11-2022_20_51_32_keas6a.png" alt="Featured image 1 for Notakto: A Haskell game with Apecs and Raylib">
              </div>
            
              <div class="swiper-slide">
                <img src="https://res.cloudinary.com/aas-sh/image/upload/v1668959570/blog/2022/11/20-11-2022_15_52_00_njlrim.png" alt="Featured image 2 for Notakto: A Haskell game with Apecs and Raylib">
              </div>
            
              <div class="swiper-slide">
                <img src="https://res.cloudinary.com/aas-sh/image/upload/v1668357984/blog/2022/11/13-11-2022_16_46_16_g6uf5j.png" alt="Featured image 3 for Notakto: A Haskell game with Apecs and Raylib">
              </div>
            
              <div class="swiper-slide">
                <img src="https://res.cloudinary.com/aas-sh/image/upload/v1668335749/blog/2022/11/13-11-2022_10_35_33_e1xmdy.png" alt="Featured image 4 for Notakto: A Haskell game with Apecs and Raylib">
              </div>
            
          </div>
          <div class="swiper-pagination"></div>
        </div>
        <script>
          var swiper = new Swiper('.featured-swiper', {
            direction: 'horizontal',
            loop: true,
            slidesPerView: 1,
            autoplay: {
              delay: 5000,
              disableOnInteraction: true,
            },
            pagination: {
              el: '.swiper-pagination',
              clickable: true,
            },
          });
        </script>
      
    </div>
  </div>



<header id="article-header" class="container is-max-widescreen">
  <div class="columns is-vcentered is-8">

    <div class="column p-4">
      <h1 class="title is-1">Notakto: A Haskell game with Apecs and Raylib</h1>
      
        <h2 class="subtitle is-4">My return to the Apecs, 4 years later.</h2>
      
      
        <div class="description">
          My previous post on Apecs was very well received, but I've seen a lot of people using the now-out-of-date code and somewhat struggling. Time to dive back in!
        </div>
      
      <div class="authors is-monospace">
        <span class="is-size-7">
          
            Ashley Rose
          
        </span>
      </div>
    </div>

    <div class="column is-one-third p-4">
      <div class="is-monospace is-size-7">
        <ul>
          
            <li class="mt-1">
              <i class="las la-calendar-day"></i> November 20, 2022
            </li>
          
          
            <li class="mt-1">
              <i class="las la-stopwatch"></i> 92 Minutes
            </li>
          
          
          
            <li class="mt-1 break-words has-text-left">
              <i class="las la-tags"></i>
              <div class="tags" style="display:inline;">
                
                  <a class="tag Tutorial" href="../../tag/Tutorial/">Tutorial</a>
                
                  <a class="tag Game" href="../../tag/Game/">Game</a>
                
                  <a class="tag Haskell" href="../../tag/Haskell/">Haskell</a>
                
                  <a class="tag Functional" href="../../tag/Functional/">Functional</a>
                
              </div>
            </li>
          
          
            <li style="margin-top:-0.25rem;">
              <i class="las la-code-branch"></i>
              <a href="https://github.com/ashe/ashe.github.io/commit/d09de11">d09de11: Notakto: Updated post with latest changes to codebase</a>
            </li>
          
        </ul>
      </div>
    </div>

  </div>
</header>


<div class="container is-widescreen mb-2">
  <div class="columns is-desktop is-centered m-0">

    
      <div id="side-toc" class="column is-3">
        <div class="table-of-contents">
          <ul class><li><a href="#previously-on-apecs">Previously on Apecs</a></li><li><a href="#about-this-post">About this post</a></li><li><a href="#introduction">Introduction</a><ul class><li><a href="#what-is-the-ecs-pattern">What is the ECS pattern?</a></li><li><a href="#what-is-raylib">What is Raylib?</a></li><li><a href="#what-is-notakto">What is Notakto?</a></li></ul></li><li><a href="#getting-started">Getting started</a><ul class><li><a href="#initial-commit">Initial commit</a></li><li><a href="#introducing-libraries">Introducing libraries</a></li><li><a href="#single-file-example">Single file example</a><ul class><li><a href="#imports-options-and-extensions">Imports, options and extensions</a></li><li><a href="#creating-and-initialising-a-world">Creating and initialising a World</a></li><li><a href="#updating-and-rendering">Updating and rendering</a></li></ul></li></ul></li><li><a href="#visualising-the-state-of-the-game">Visualising the state of the game</a><ul class><li><a href="#what-should-be-an-entity">What should be an entity?</a></li><li><a href="#the-types-module">The Types module</a></li><li><a href="#the-boardcomponent">The BoardComponent</a></li><li><a href="#rendering">Rendering</a></li><li><a href="#multiple-boards">Multiple boards</a></li><li><a href="#board-state">Board state</a></li></ul></li><li><a href="#making-moves">Making moves</a><ul class><li><a href="#preparing-the-raycast">Preparing the raycast</a></li><li><a href="#identifying-the-looked-at-cell">Identifying the looked-at cell</a></li><li><a href="#placing-crosses-dynamically">Placing crosses dynamically</a></li><li><a href="#killing-boards">Killing boards</a></li><li><a href="#restarting-the-game">Restarting the game</a></li><li><a href="#making-players-take-turns">Making players take turns</a></li><li><a href="#bonus-manually-implementing-first-person-camera">Bonus: Manually implementing first-person camera</a></li></ul></li><li><a href="#wrapping-up">Wrapping up</a></li></ul>
        </div>
      </div>
    

    <div class="column">
      <article class="container is-max-desktop">
        <div class="columns is-desktop is-centered">
          <div class="column can-shrink-for-toc">
            <div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the repository can be found <a href="https://github.com/Ashe/Notakto/">here</a>.</p>
</div>
<div class="note infobox fill-horizontal">
<div class="header">
<span class="las la-info-circle mr-3"></span>Note - Out of date, but not to worry!
</div>
<p>I wrote this post as I made the project, but to make things easier for newer readers I have been updating the codebase so that it takes advantage of some of the newer features of <a href="https://hackage.haskell.org/package/h-raylib">h-raylib</a> and removes depreciated code. Check out the git repository for the latest updates and be careful when copy-pasting code — unless you’re running my repository or you’re using the exact same versions of libraries, some of this code may not work.</p>
<p>The biggest change was that I’ve manually implemented the first person camera, which has the added bonus of showing how we can handle input and make changes to our ECS world.</p>
</div>
<section id="previously-on-apecs" class="article-section">
<h1><span>Previously on Apecs</span><a href="#previously-on-apecs" class="anchor las la-link" title="previously-on-apecs"></a></h1>
<p>Roughly 4 years ago, I wrote the post <a href="../../blog/making-a-game-with-haskell-and-apecs/">An introduction to game development to game development in Haskell using Apecs</a>. I like to think it was one of my most well-received blog posts <a href="https://github.com/jonascarpay/apecs#links">considering it is featured on the Apecs repository itself</a>, as well as being a common topic across emails and communications I receive.</p>
<p><a href="https://hackage.haskell.org/package/apecs">Apecs</a> is a ‘fast <a href="https://en.wikipedia.org/wiki/Entity_component_system">Entity-Component-System</a> library for game programming’ written in <a href="https://www.haskell.org/">Haskell</a>. It is by far one of the best ECS implementations I’ve used and also happens to be my favourite way of structuring games when using Haskell.</p>
<p>However, enough time has passed (4 years!) that some of the tricks and methods used in that blog post are old enough to confuse beginners. Since that was never my intention, I thought I’d make a new blog post about it!</p>
</section>
<section id="about-this-post" class="article-section">
<h1><span>About this post</span><a href="#about-this-post" class="anchor las la-link" title="about-this-post"></a></h1>
<p>This post is going to be a little bit different. Whereas normally I’d finish a project and write a post about it, in this post I want to write it as I go along! Each time I finish implement something substantial, I’m going to add to this post so that I can really capture more of the development process.</p>
<p>This may have a few side-effects, however. Firstly, code we write near the beginning may change towards the end. If I make a simple mistake (such as a syntax improvement), I’ll simply swap it out for the superior. But I want the big decisions I make to be written about so that if I later decide against it I can articulate properly why in the post.</p>
<p>My blog has support for both projects and blog posts; this post is a blog post since it is capturing a moment in time, like a photograph. The associated project for this page will be the formal write-up for how the game works, but this will act more as a portfolio piece than as a tutorial. This is a bit of an experiment for me, so please let me know how you think it goes!</p>
</section>
<section id="introduction" class="article-section">
<h1><span>Introduction</span><a href="#introduction" class="anchor las la-link" title="introduction"></a></h1>
<section id="what-is-the-ecs-pattern" class="article-section">
<h2><span>What is the ECS pattern?</span><a href="#what-is-the-ecs-pattern" class="anchor las la-link" title="what-is-the-ecs-pattern"></a></h2>
<p>As the name suggests, the ECS pattern is divided into three parts: entities, components and systems. These parts work together to form the foundations of your game’s architecture.</p>
<ul>
<li><p><strong>Entity —</strong> Alone, an entity is just a unique identifier, such as a simple integer value. They aren’t very useful by themselves!</p></li>
<li><p><strong>Component —</strong> Data, essentially. Anything that has data you need to store between frames, such as position, velocity, health or gold. Each component is attached to an entity in some way — some games have just a big database where an entity is just an integer used as a look-up key, whereas others (who probably would be using <a href="https://en.wikipedia.org/wiki/Object-oriented_programming">object oriented programming</a>) might compose component lists within the entity class itself.</p></li>
<li><p><strong>System —</strong> The magic part that a lot of people miss out on! A system is simple: it iterates through entities and updates their components in some way. A player movement system might cherry-pick the player’s entity and update the velocity component with respect to whatever keys are held on the keyboard; a movement system would then iterate through <em>all</em> entities with positions and velocities and update their positions accordingly. If you can break the logic of your game into systems then things become a lot simpler and safer.</p></li>
</ul>
<p>It was through ECS that I began to understand how modern game engines work (no thanks to you, university!) since having a greater appreciation for how games can be architected gave me an insight that couldn’t be taught through anything other experience. That isn’t to say that game engines all use ECS, in fact most of them don’t since they want to write their own systems (rendering, physics, scripting etc) that <em>you</em> then use and may or may not customise. Also, they probably don’t implement entities and components in the same way; both <a href="https://unity.com/">Unity</a> and <a href="https://www.unrealengine.com/en-US">Unreal</a> engines allow for logic to be placed in their components whereas the ECS pattern encourages components to be purely data.</p>
</section>
<section id="what-is-raylib" class="article-section">
<h2><span>What is Raylib?</span><a href="#what-is-raylib" class="anchor las la-link" title="what-is-raylib"></a></h2>
<p>One thing we haven’t mentioned yet is that this project will be using <a href="https://www.raylib.com/">Raylib</a> for the rendering side of things. I’ve always wanted to learn more about Raylib, and my chance came when I found the <a href="https://hackage.haskell.org/package/h-raylib">Haskell bindings</a> released recently.</p>
<p>We won’t spend too much time talking about Raylib, in fact I’m using it purely because it’s a really easy way to get things on-screen. The documentation style surprises me a bit, with a preference for documenting the source code rather than an online version of the API. That said, for our purposes the <a href="https://www.raylib.com/cheatsheet/cheatsheet.html">cheatsheet</a> is an excellent resource for just understanding what functions Raylib provides us with and what arguments they take.</p>
</section>
<section id="what-is-notakto" class="article-section">
<h2><span>What is Notakto?</span><a href="#what-is-notakto" class="anchor las la-link" title="what-is-notakto"></a></h2>
<p><a href="https://en.wikipedia.org/wiki/Notakto">Notakto</a> is a variant of tic-tac-toe in which both players play using ‘crosses’ as their markers across multiple tic-tac-toe boards. Three crosses in a row on any board will ‘kill’ it, meaning that the board can no longer be played on. When there is only one board remaining, the player who kills it is considered the loser, meaning that to win you have to get yourself in a position where you force the other person to get three-in-a-row on the final board. It is still a solveable game like regular tic-tac-toe, but the stratagies involve enough effort that you will probably not find many people who can figure them out on their own.</p>
<p>Why did I chose to make Notakto? There’s a beauty in making a game where the rules are already well-defined since there is already a definition of ‘done’ — I know what I’m working towards and the project has scope, a perfect scenario for an experimental tutorial!</p>
<p>And with that, it’s 10:00 am, let’s begin our journey!</p>
</section>
</section>
<section id="getting-started" class="article-section">
<h1><span>Getting started</span><a href="#getting-started" class="anchor las la-link" title="getting-started"></a></h1>
<section id="initial-commit" class="article-section">
<h2><span>Initial commit</span><a href="#initial-commit" class="anchor las la-link" title="initial-commit"></a></h2>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>I will be committing as I go, so even though this blog post may be revised for cleaner reading, the repository will always tell the full story. Each section will have a permalink to the commit I was at so that you can see how the project evolves. I won’t be detailing every single change in this blog post, so if you really are following along you may need to check the repository and fill the blanks in yourself.</p>
<p>A link to the repository’s first commit can be found <a href="https://github.com/Ashe/Notakto/tree/0852350c18071b6332899639055d3c38c1976963">here</a>.</p>
</div>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668334893/blog/2022/11/13-11-2022_10_20_31_ywlsij.png" title="The folder structure of the initial commit." class="w-full object-cover" alt="The folder structure of the initial commit." />
<div class="caption">
<p>The folder structure of the initial commit.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/0852350c18071b6332899639055d3c38c1976963" title="Notakto">Notakto</a>
</div>
</div>
</div>
<p>Here we go! I’ve just pushed an initial commit with my standard Haskell bits and bobs. I always like making a library and separating executable-only code from the game itself, meaning that if we wanted multiple executables that handle the game setup in different ways (i.e. terminal or GUI) then we can. I’ve also got a testing folder, maybe we’ll write some tests as we go, who knows?</p>
<p>You may also notice that I am using <a href="https://nixos.org/">Nix</a> to build and run this project, so you should just be able to use <code>nix run</code> to run the project at any point in time. If you want to work in this repository, you can use <code>nix develop</code> to get your development environment set up.</p>
<p>At this point in time, running the project should print <code>Hello, Notakto</code>.</p>
</section>
<section id="introducing-libraries" class="article-section">
<h2><span>Introducing libraries</span><a href="#introducing-libraries" class="anchor las la-link" title="introducing-libraries"></a></h2>
<p>After setting up the repository, my next step with any project is adding the libraries I know I’ll be using and getting a modified example running to demonstrate that things are working correctly. Lets begin by updating our cabal file to include the <code>h-raylib</code> and <code>apecs</code>.</p>
<pre class="cabal"><code>library
  exposed-modules:  Lib
  hs-source-dirs:   src/lib
  build-depends:
    base,
    apecs,
    h-raylib
  default-language: Haskell2010</code></pre>
</section>
<section id="single-file-example" class="article-section">
<h2><span>Single file example</span><a href="#single-file-example" class="anchor las la-link" title="single-file-example"></a></h2>
<section id="imports-options-and-extensions" class="article-section">
<h3><span>Imports, options and extensions</span><a href="#imports-options-and-extensions" class="anchor las la-link" title="imports-options-and-extensions"></a></h3>
<p>Now we can try and use our dependencies by modifying an example! Thankfully, <code>h-raylib</code> supplies us with a <a href="https://github.com/Anut-py/h-raylib/tree/606936336922dea13517abf4d136f17b162efcc1/examples/first-person-camera">first-person-camera example</a>, and I already have some Apecs examples from the <a href="https://github.com/Ashe/HSRogue/">project</a> featured in my <a href="https://aas.sh/blog/making-a-game-with-haskell-and-apecs/">previous post</a>!</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# OPTIONS -Wall #-}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Lib</span> (main) <span class="kw">where</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (unless)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Apecs</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Colors</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Constants</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Types</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Raylib.Types</span> (<span class="dt">Vector3</span> (..))</span></code></pre></div>
<p>Here is how our <code>Lib</code> module is setup now. We’re still working in one file to keep it simple, so it’s okay for things to be messy.</p>
<ul>
<li>I use the <code>-Wall</code> language option just to make sure we’re ironing out warnings we go — personal prefence.</li>
<li>The language extensions you see are all used by Apecs (or at least, the example made use of them). I know for a fact that <code>TemplateHaskell</code> is used as an easy way of building a <code>World</code> type for use throughout the application.</li>
<li><code>Lib</code> only needs to export <code>main</code> for now, but if we ever want to export a configuration data type that our client can provide then this is where we’d put it.</li>
<li>I try to structure my includes with my ‘Haskell libraries’ at the top (i.e. things that aren’t specific to my project), followed by blocks of imports for my dependencies:
<ul>
<li>Apecs has quite a nice API; it doesn’t get messy if you just import it in its entirety and it almost feels like it’s part of the language.</li>
<li>Raylib has a <em>lot</em> of things going on (again, refer to the <a href="https://www.raylib.com/cheatsheet/cheatsheet.html">cheatsheet</a>, so I’ve <code>qualified</code> it. Normally I’d explicitly write every function I use, however for this tutorial I’m going to use qualifications so that you can easily tell when something is a Raylib thing and when it’s something else.
<ul>
<li>I made an exception for <code>Raylib.Types</code> — certain types are quite commonly used throughout the project and so rather than typing <code>RL.Vector3</code> constantly I instead explicitly imported it so that we can use it without restraint.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="creating-and-initialising-a-world" class="article-section">
<h3><span>Creating and initialising a World</span><a href="#creating-and-initialising-a-world" class="anchor las la-link" title="creating-and-initialising-a-world"></a></h3>
<p>Next up is creating our <code>World</code>. In Apecs, the <code>World</code> is a type built specifically for your components to live in; that’s why <code>TemplateHaskell</code> is used to automatically write the code that glues your components together. The <code>initWorld</code> function is also a result of this template, which is why you might find it hard to find the <code>World</code> type and <code>initWorld</code> in the <a href="https://hackage.haskell.org/package/apecs"><code>apecs</code> documentation</a>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Define a component, a Camera</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Camera</span> <span class="ot">=</span> <span class="dt">Camera</span> <span class="dt">RL.Camera3D</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create a world featuring the lonely Camera component</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>makeWorldAndComponents <span class="st">&quot;World&quot;</span> ['<span class="dt">'Camera</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Initialise our world in the main function, and give it to our game's systems</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> initWorld <span class="op">&gt;&gt;=</span> runSystem (initialise <span class="op">&gt;&gt;</span> run <span class="op">&gt;&gt;</span> terminate)</span></code></pre></div>
<p>The big important function here is <code>makeWorldAndComponents</code>. In Apecs, there are multiple template-Haskell functions you can use to create your <code>World</code> and associated components:</p>
<ul>
<li><code>makeWorld</code> takes your components and constructs your <code>World</code> and component associations, but it doesn’t assume anything about your component’s storage mechanisms.</li>
<li><code>makeWorldAndComponents</code> calls <code>makeWorld</code>, but then also calls <code>makeMapComponents</code> which takes all of your components and defines <code>Component</code> instances with a <code>Map</code> store. In simple terms, it sets up your components with the most common storage mechanism, <code>Map</code>.</li>
</ul>
<p>In this tutorial, I’ll be using <code>makeWorldAndComponents</code> to keep things simple, but if you ever want components that have specific constraints you might want to consider <code>makeWorld</code> and defining your mechanisms manually like I did <a href="../../blog/making-a-game-with-haskell-and-apecs/#creating-components">in my previous post</a>.</p>
<div class="note infobox fill-horizontal">
<div class="header">
<span class="las la-info-circle mr-3"></span>Note - Manual storage definitions
</div>
<p>You probably want to use <code>makeWorld</code> if you want to be cool so that you have full control. Here’s how components would look if you want things to be done manually:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 'Map' storage: standard storage where any entity can have one</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- e.g. Every entity may have a name</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Name</span> <span class="ot">=</span> <span class="dt">Name</span> <span class="dt">String</span> <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Component</span> <span class="dt">Name</span> <span class="kw">where</span> <span class="kw">type</span> <span class="dt">Storage</span> <span class="dt">Name</span> <span class="ot">=</span> <span class="dt">Map</span> <span class="dt">Name</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 'Unique' storage: only one entity can have this component at maximum</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- e.g. Only zero or one entities can be marked as a player at any given time</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Player</span> <span class="ot">=</span> <span class="dt">Player</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Component</span> <span class="dt">Player</span> <span class="kw">where</span> <span class="kw">type</span> <span class="dt">Storage</span> <span class="dt">Player</span> <span class="ot">=</span> <span class="dt">Unique</span> <span class="dt">Player</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- 'Global' storage: exactly one component exists for the lifetime of the game</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- e.g. There only needs to be one definition of the game's configuration</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note that querying for this on ANY entity will yield the global one,</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- effectively sharing the component between all entities</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Also note that globals need instances for Monoid and Semigroup</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Config</span> <span class="dt">String</span> <span class="dt">Int</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monoid</span> <span class="dt">Config</span> <span class="kw">where</span> <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Config</span> <span class="st">&quot;Foo&quot;</span> <span class="dv">0</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Config</span> <span class="kw">where</span> (<span class="op">&lt;&gt;</span>) <span class="ot">=</span> <span class="fu">mappend</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Component</span> <span class="dt">Config</span> <span class="kw">where</span> <span class="kw">type</span> <span class="dt">Storage</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Global</span> <span class="dt">Config</span></span></code></pre></div>
<p>So even though I’m going to be lazy on this post so I can say ‘make a new component’, I really do encourage people reading this to <strong>try and use <code>makeWorld</code> instead</strong>.</p>
<div class="caption">
<p>For more information, <a href="https://hackage.haskell.org/package/apecs-0.9.4/docs/Apecs-Stores.html">check out the documentation</a> and maybe even <a href="../../blog/making-a-game-with-haskell-and-apecs/#creating-components">my previous post</a>.</p>
</div>
</div>
<p>So, what are the <code>initialise</code>, <code>run</code> and <code>terminate</code> systems? Well, they are just functions with the type <code>System World ()</code>!</p>
<ul>
<li><code>System</code> is an Apecs type defining a system, one of the parts of the ECS pattern. Note that <code>System w a</code> is mapped to <code>SystemT w IO a</code> under the hood; it’s just a convenience type.</li>
<li><code>World</code> is our world type created by template haskell in the above snippet.</li>
<li><code>()</code> is the absence of type; we aren’t expecting these systems to return anything, so these particular functions are only for executing side effects.</li>
</ul>
<p>Let’s first look at <code>initialise</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Simple system, doesn't return anything</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ot">initialise ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- We're in the 'System' monad, use 'do' to compose side effects</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>initialise <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Define a Raylib 3D perspective camera and name it 'camera'</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> camera <span class="ot">=</span> <span class="dt">RL.Camera3D</span> (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) (<span class="dt">Vector3</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">1</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">70</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        RL.cameraProjection'perspective</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Create a global entity with our camera component</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 'set' is an apecs function for setting a component's state on a given entity</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 'global' refers to the singular and unique global entity of the game</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 'Camera' refers to the constructor for our component which contains a RL.3DCamera</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Camera</span> camera</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- The 'System' monad has IO, remember 'System w a = SystemT w IO a'!</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Now we can compose side effects for IO, which is what h-raylib uses</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    RL.initWindow <span class="dv">1920</span> <span class="dv">1080</span> <span class="st">&quot;App&quot;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    RL.setTargetFPS <span class="dv">60</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    RL.setCameraMode camera RL.cameraMode'firstPerson</span></code></pre></div>
<p>The biggest takeaway from the above snippet is to remember that just because we’re in Apecs-land doesn’t mean that we’re constrained to only using Apecs functions. <code>System</code> is a <code>type</code> constructor for <code>SystemT</code>, which <code>apecs</code> documentation explains:</p>
<blockquote>
<p>A <code>SystemT</code> is a newtype around <code>ReaderT w m a</code>, where <code>w</code> is the game world variable. Systems serve to:</p>
<ul>
<li>Allow type-based lookup of a component’s store through <code>getStore</code>.</li>
<li>Lift side effects into their host Monad.</li>
</ul>
</blockquote>
<p>We can do <code>IO</code> 🎉 Before we continue though, let’s look into <code>terminate</code>, since it’s good practice to always write in programming to always write <code>delete</code> where there’s <code>new</code>, or a <em>destructor</em> whenever you write a <em>constructor</em>. We have made our window, so let’s handle closing it before we forget:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- When terminate is called, just close the window</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ot">terminate ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>terminate <span class="ot">=</span> liftIO RL.closeWindow</span></code></pre></div>
<p>This is a short and sweet one!</p>
<div class="help infobox fill-horizontal">
<div class="header">
<span class="las la-question-circle mr-3"></span>Why didn't we just manage the window in main?
</div>
<p>The question on your mind might be <em>“why did we need to do this in a <code>System</code>?”</em> The answer to that lies in the names: <code>initialise</code> and <code>terminate</code>. Yes, the Raylib specific stuff could be done purely in <code>IO</code> without Apecs getting involved, but this is constraining.</p>
<p>What if we want to store the want to load and save data using a file when the application opens and closes? What if we need to correct the state of the game before we enter the game loop, or after it’s concluded? So long as we’re in a <code>System</code>, we have access to all the components in the <code>World</code>; exiting back into <code>IO</code> removes this ability and so I prefer to use <code>liftIO</code> within <code>System</code> to get the best of both worlds.</p>
</div>
</section>
<section id="updating-and-rendering" class="article-section">
<h3><span>Updating and rendering</span><a href="#updating-and-rendering" class="anchor las la-link" title="updating-and-rendering"></a></h3>
<p>We aren’t quite done with our single-file example since we have one remaining undefined function: <code>run</code>. Let’s dive in:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">run ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  update</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  render</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  shouldClose <span class="ot">&lt;-</span> liftIO RL.windowShouldClose</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  unless shouldClose run</span></code></pre></div>
<p>Hang on a moment, this is a <strong>game loop</strong>! So in <code>main</code>, we had <code>initialise &gt;&gt; run &gt;&gt; terminate</code>, you can now see that the reason the program doesn’t terminate immediately is because <code>run</code> is hogging the thread and infinitely looping until told otherwise!</p>
<p>So what are <code>update</code> and <code>render</code>? Well, when you are in a monad be it <code>IO</code> or <code>System</code>, you can easily call functions of the same monadic type to compose side effects. You could pretty much substitute <code>update</code> and <code>render</code> for their contents and everything will work the same; this is a way of breaking things up. I like updating the game and then rendering the result. We can split these two steps into as many more steps as we need, but for our single file example they are singular systems that just handle the entire game.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Simple system</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">update ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>update <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Retrieve the camera component from the global entity (c is a RL.Camera3D)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> c <span class="ot">&lt;-</span> get global</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Update the camera and store the updated version in c'</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Also note the use of liftIO to dip into the IO monad to allow the use of raylib</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  c' <span class="ot">&lt;-</span> liftIO <span class="op">$</span> RL.updateCamera c</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Replace the global entity's Camera with a new one containing the updated camera</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Camera</span> c'</span></code></pre></div>
<p>I was a bit alarmed at first at how small this function is — where is the input handling? Where’s the movement speed definitions and all the other things we expect to see in a first-person game? Well it looks like Raylib is has some very plug-and-play style functions, which is nice to see when playing around. I’m sure anyone looking to make an FPS will be able to roll their own movement system, but for us we’ll be removing this pretty quickly since funnily enough Notakto is not a competitor to <a href="https://www.callofduty.com/uk/en/">Call of Duty</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">render ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>render <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> camera <span class="ot">&lt;-</span> get global</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    RL.beginDrawing</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    RL.clearBackground RL.black</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    RL.drawFPS <span class="dv">10</span> <span class="dv">20</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    RL.beginMode3D camera</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    RL.drawGrid <span class="dv">10</span> <span class="dv">1</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    RL.drawCircle3D (<span class="dt">Vector3</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">1</span>) <span class="dv">2</span> (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">0</span> RL.white</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    RL.drawLine3D (<span class="dt">Vector3</span> <span class="dv">3</span> <span class="dv">0</span> <span class="dv">1</span>) (<span class="dt">Vector3</span> <span class="dv">1</span> <span class="dv">2</span> <span class="dv">1</span>) RL.white</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    RL.drawLine3D (<span class="dt">Vector3</span> <span class="dv">3</span> <span class="dv">2</span> <span class="dv">1</span>) (<span class="dt">Vector3</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">1</span>) RL.white</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    RL.drawCubeWiresV (<span class="dt">Vector3</span> (<span class="op">-</span><span class="dv">2</span>) <span class="dv">1</span> <span class="dv">0</span>) (<span class="dt">Vector3</span> <span class="dv">1</span> <span class="dv">2</span> <span class="dv">1</span>) RL.white</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    RL.endMode3D</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    RL.endDrawing</span></code></pre></div>
<p>The <code>render</code> system is very straightforward. We grab our camera out of our Apecs <code>World</code> and then use it in the <code>IO</code> monad to help Raylib render the world. I won’t go into much detail here.</p>
<p>After what feels like an eternity (it has taken me 2 hours to write this!), here’s our single file example up and running! Time for a toilet break and a glass of water!</p>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668335749/blog/2022/11/13-11-2022_10_35_33_e1xmdy.png" title="Screenshot of the single file example running." class="w-full object-cover" alt="Screenshot of the single file example running." />
<div class="caption">
<p>Screenshot of the single file example running.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/dd26d756904358cc907a8db11ae66392f45bfa96" title="Notakto">Notakto</a>
</div>
</div>
</div>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/0852350c18071b6332899639055d3c38c1976963">here</a>.</p>
</div>
</section>
</section>
</section>
<section id="visualising-the-state-of-the-game" class="article-section">
<h1><span>Visualising the state of the game</span><a href="#visualising-the-state-of-the-game" class="anchor las la-link" title="visualising-the-state-of-the-game"></a></h1>
<section id="what-should-be-an-entity" class="article-section">
<h2><span>What should be an entity?</span><a href="#what-should-be-an-entity" class="anchor las la-link" title="what-should-be-an-entity"></a></h2>
<p>I believe that the next step of this project is to visualise the boards and the marks placed upon them. In terms of priority, I want to get the visuals set up first otherwise testing the game is going to be a pain, but in order to get that done we need to create a basic representation of state!</p>
<p>So, representations of state — <code>data</code> types! Let’s make some new types to represent things we’ll need in our game! But wait.. Do you hear alarm bells?</p>
<div class="danger infobox fill-horizontal">
<div class="header">
<span class="las la-exclamation-circle mr-3"></span>Danger - Don't rush!
</div>
<p>While it’s all fun and games to get experimental and start playing around with Haskell’s wonderful type system, sometimes we can get bogged down in actually using these types and trying to make them work.</p>
<p>Let’s take a moment to appreciate the blank slate we have right now and come up with at least a hypothesis for how things should be laid out.</p>
</div>
<p>After heeding that warning, let’s create an action plan. What should consist of an entity in our game? More specifically, should the boards themselves be entities? Should the marks that players place be entities? One could argue that both the board itself and the crosses placed could be entities. I disagree; I believe that the crosses don’t really make sense without the context of a board, and so there’d be little use in having an entity representing each cross in isolation (it might even make things more confusing trying to figure out which board each cross is on).</p>
<div class="caption-frame apply-shadow">
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Thing</th>
<th style="text-align: center;">Is Entity?</th>
<th style="text-align: center;">Reasoning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Player</td>
<td style="text-align: center;">Maybe</td>
<td style="text-align: center;">The player won’t have much data of their own; they can be represented elsewhere. If it turns out we want things like customisable player names and colours then they could become entities.</td>
</tr>
<tr class="even">
<td style="text-align: center;">‘Game’</td>
<td style="text-align: center;">Global</td>
<td style="text-align: center;">The global entity can contain a component with the information for who’s turn it is (either player one or player two).</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Cross</td>
<td style="text-align: center;">No</td>
<td style="text-align: center;">Crosses don’t have much of their own data other than their location, which is dependent on the board. Standard Haskell data types will suffice. If they were their own entity, we could potentially have more than nine crosses assigned to a signle board.</td>
</tr>
<tr class="even">
<td style="text-align: center;">Board</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">Boards contain the state of crosses placed on them, as well as whether they are ‘dead’ or not. Their state will need to be rendered.</td>
</tr>
</tbody>
</table>
<div class="caption">
<p>A table describing my plan for entities in Notakto.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/e71210405272674b49929c70cca0e2006df3888e" title="Notakto">Notakto</a>
</div>
</div>
</div>
<p>I believe that’s all we need to think about to get started; let’s do some programming.</p>
</section>
<section id="the-types-module" class="article-section">
<h2><span>The Types module</span><a href="#the-types-module" class="anchor las la-link" title="the-types-module"></a></h2>
<p>A single-file example is nice, but is only going to impede us going forward; let’s make a new module containing all of our components and miscellaneous types: <code>Types.hs</code>!</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# OPTIONS -Wall #-}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Types</span> (</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">World</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  initWorld,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> (<span class="op">..</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Apecs</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Types</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Camera</span> <span class="ot">=</span> <span class="dt">Camera</span> <span class="dt">RL.Camera3D</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>makeWorldAndComponents <span class="st">&quot;World&quot;</span> ['<span class="dt">'Camera</span>]</span></code></pre></div>
<p>So I’ve moved all language extensions into this new file, since they’re only relevant for the <code>World</code> initialisation code. We now have a cleaner space to declare new data types, and since components <em>should</em> be simple, we should be fine to place them all in here for the duration of this project.</p>
</section>
<section id="the-boardcomponent" class="article-section">
<h2><span>The BoardComponent</span><a href="#the-boardcomponent" class="anchor las la-link" title="the-boardcomponent"></a></h2>
<p>In the previous section, we asked the question “what should be an entity?” Now that we know of some certain entities, we now need to think about what components we might like to attach. The one I’m most interested in right now is a representation of a board, the standard tic-tac-toe battle ground.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-----------</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Types --</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">-----------</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Cell</span> <span class="ot">=</span> <span class="dt">Empty</span> <span class="op">|</span> <span class="dt">Filled</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">----------------</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Components --</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">----------------</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">CameraComponent</span> <span class="ot">=</span> <span class="dt">Camera</span> <span class="dt">RL.Camera3D</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">BoardComponent</span> <span class="ot">=</span> <span class="dt">Board</span> {</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="ot">  _tl ::</span> <span class="dt">Cell</span>,<span class="ot"> _tc ::</span> <span class="dt">Cell</span>,<span class="ot"> _tr ::</span> <span class="dt">Cell</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="ot">  _ml ::</span> <span class="dt">Cell</span>,<span class="ot"> _mc ::</span> <span class="dt">Cell</span>,<span class="ot"> _mr ::</span> <span class="dt">Cell</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="ot">  _bl ::</span> <span class="dt">Cell</span>,<span class="ot"> _bc ::</span> <span class="dt">Cell</span>,<span class="ot"> _br ::</span> <span class="dt">Cell</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>} <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>makeWorldAndComponents <span class="st">&quot;World&quot;</span> ['<span class="dt">'CameraComponent</span>, '<span class="dt">'BoardComponent</span>]</span></code></pre></div>
<p>This will do for now I think, no need to get too fancy. One thing I’d like to draw your attention to is the separation of standard types and types that are used as components — components are the things you’ll be operating on when using Apecs, so try to organise your code in a way which makes sense to you. I’ve appended <code>Component</code> to my component types, but I’ve omitted it from my data constructors so I don’t have to type it out as much.</p>
<p>Now go back to <code>Lib.hs</code> and fix any errors we have and ensure things still run. Let’s also create an entity with <code>BoardComponent</code>s to represent a singular board while we’re at it!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">initialise ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>initialise <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Update location of camera so we can look at origin</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> camera <span class="ot">=</span> <span class="dt">RL.Camera3D</span> (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">6</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">90</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        RL.cameraProjection'perspective</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Define what a blank board looks like</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      newBoard <span class="ot">=</span> <span class="dt">Board</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Camera</span> camera</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Create a new entity with a blank board</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Note: if you want the return value, omit '_'</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  newEntity_ newBoard</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    RL.initWindow <span class="dv">1920</span> <span class="dv">1080</span> <span class="st">&quot;App&quot;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    RL.setTargetFPS <span class="dv">60</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    RL.setCameraMode camera RL.cameraMode'firstPerson</span></code></pre></div>
</section>
<section id="rendering" class="article-section">
<h2><span>Rendering</span><a href="#rendering" class="anchor las la-link" title="rendering"></a></h2>
<p>Now that we have some data floating around cyberspace it’s time to prove that we do indeed have some state by trying to visualise it. Now for the sake of fun, I’m going to <strong>continue to use the first-person camera</strong>. If this was any other project I’d throw it out the window, but it gives us an event handling system built as well as a great opportunity to experience Notakto in 3D! Throwing it away right now would just create a detour since we can use it in the short term to explore our world.</p>
<div class="help infobox fill-horizontal">
<div class="header">
<span class="las la-question-circle mr-3"></span>What if I want to do 2D?
</div>
<p>If you’re planning to use this project as a springboard for a 2D project, you might be thinking of splintering off here and doing some exploration with Raylib’s 2D camera. I have to say that it doesn’t look too scary, so maybe this would be a good point for you to take a break and play around with it. We will be using cubes and 3D shapes to represent our boards in 3D space, so you’ll have to translate things as you go. If you want to continue using 3D, I’m sure it wouldn’t take long to switch it out for 2D later down the line.</p>
<p>If you choose to split off now, good luck!</p>
</div>
<p>Once again, I’m going to make a new module: <code>Rendering.hs</code>. This module is going to import <code>Types</code> and be imported by our main <code>Lib</code> module. This module will house all the dirty Raylib rendering things so that our main file can be more gameplay-focused. I’ve also moved the <code>render</code> function into this module so that we only have to export a single function for the entire module.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Rendering</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  render</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Apecs</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Colors</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Constants</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Raylib.Types</span> <span class="kw">as</span> <span class="dt">RL</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Raylib.Types</span> (<span class="dt">Vector3</span> (..))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Types</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="ot">render ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>render <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> camera <span class="ot">&lt;-</span> get global</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    RL.beginDrawing</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    RL.clearBackground RL.black</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    RL.drawFPS <span class="dv">10</span> <span class="dv">20</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    RL.beginMode3D camera</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    RL.drawGrid <span class="dv">10</span> <span class="dv">1</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Our systems are sandwiched between the 'begin' and 'end' functions</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  renderBoards</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    RL.endMode3D</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    RL.endDrawing</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoards ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>renderBoards <span class="ot">=</span> <span class="fu">undefined</span></span></code></pre></div>
<p>Time to get creative! We need to draw some array of cubes and shapes to visualise the board! Our use of <code>RL.drawGrid</code> means we can visualise the units of the world — the grid is spaced such that each cell is 1 unit by 1 unit. Now we just need to draw 4 cuboids to mock out a hash symbol.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Those experienced with monads can probably guess what cmapM_ does</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoards ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>renderBoards <span class="ot">=</span> cmapM_ renderBoard</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- The signature of this function also qualifies as a condition, only the</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- entities that satisfy said condition will have this function mapped onto them</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- In short, only entities with a BoardComponent get rendered via this function</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoard ::</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>renderBoard b <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (<span class="dt">Vector3</span> <span class="fl">0.5</span>    <span class="fl">1.5</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (<span class="dt">Vector3</span> (<span class="op">-</span><span class="fl">0.5</span>) <span class="fl">1.5</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">2</span> <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 't' is the thickness here</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> t <span class="ot">=</span> <span class="fl">0.05</span></span></code></pre></div>
<p>The key takeaway here is <code>cmapM_</code>. Let’s quickly recap the other variants so that we can deduce what this does (I’m going to shorten the type signatures a bit here):</p>
<blockquote>
<div class="sourceCode" id="cb15"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ot">cmap ::</span> (cx <span class="ot">-&gt;</span> cy) <span class="ot">-&gt;</span> <span class="dt">System</span> w ()</span></code></pre></div>
</blockquote>
<p>This function maps a standard, non-monadic function onto all entities with <code>cx</code>. What is <code>cx</code> you might ask? Well I shortened the type signature for the blog (sorry) but it’s a polymorphic parameter representing a bundle of components. Apecs leverages Haskell’s type system to intelligently select all entities that meet the criteria for <code>cx</code>. A singular type is one of the simplest forms of using this function; notice how our <code>renderBoard</code> function <em>requires</em> a parameter of <code>BoardComponent</code>. We can actually specify more than just a single component, and Apecs will use that group as <code>cx</code>. Similarly, <code>cy</code> is a group of components to be output.</p>
<blockquote>
<div class="sourceCode" id="cb16"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">cmapM ::</span> (cx <span class="ot">-&gt;</span> <span class="dt">System</span> w cy) <span class="ot">-&gt;</span> <span class="dt">System</span> w ()</span></code></pre></div>
</blockquote>
<p>This function is very similar to <code>cmap</code> with one exception — the function mapped onto entities returns a composable side-effect of the <code>System</code> monad, which also means <em>access to <code>IO</code></em> as well as other Apecs functions. You will typically use <code>pure &lt;your components&gt;</code> to return things. Appending <code>M</code> to a function to denote the presence of a monad is very common in Haskell.</p>
<blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">cmapM_ ::</span> (cx <span class="ot">-&gt;</span> <span class="dt">System</span> w ()) <span class="ot">-&gt;</span> <span class="dt">System</span> w ()</span></code></pre></div>
</blockquote>
<p>Once again, very similar, except this time to <code>cmapM</code>. We still have access to monads, except the function we map onto entities no longer produces a <code>cy</code>. This means that the function you’re mapping onto your entities is there to only produce side-effects. In the case of <code>renderBoards</code>, we want to map a monad function to our entities, but we don’t need to return anything, so <code>cmapM_</code> is used.</p>
<p>After all of that, we have our first board rendered!</p>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668352718/blog/2022/11/13-11-2022_15_18_24_lfwnkh.png" title="Screenshot of our first board being rendered in 3D space." class="w-full object-cover" alt="Screenshot of our first board being rendered in 3D space." />
<div class="caption">
<p>Screenshot of our first board being rendered in 3D space.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/e71210405272674b49929c70cca0e2006df3888e" title="Notakto">Notakto</a>
</div>
</div>
</div>
<p>What does this tell us? Well, if we had no entities in the game that contained a <code>BoardComponent</code>, this arrangement of sticks wouldn’t appear in the world at all! We have correctly defined, initialised, stored, read and visualised state, even on a very basic level!</p>
<p>There are some things however that this doesn’t tell us:</p>
<ul>
<li>It won’t tell us <strong>how many</strong> boards there are, they all render on top of each other.</li>
<li>It won’t show us <strong>the state of the board</strong>, since we aren’t rendering crosses yet.</li>
<li>It won’t help us realise <strong>why we should love the game of Notakto</strong>.</li>
</ul>
</section>
<section id="multiple-boards" class="article-section">
<h2><span>Multiple boards</span><a href="#multiple-boards" class="anchor las la-link" title="multiple-boards"></a></h2>
<p>Let’s address this issue of not being able to see multiple boards. There’s two ways I can think of for going about this:</p>
<ul>
<li>We could create a new component representing the origin of the board in 3D space.</li>
<li>We could count the number of boards and distribute them evenly along the x-axis.</li>
</ul>
<p>Honestly, we’ll probably end up doing option one eventually, but because I like the idea of boards being automatically arranged I’m going to go with option 2 for now. I think the end game is a mixture of both approaches, where we automatically generate positions for each board, for instance in a circle or something.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoards ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>renderBoards <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Now we count how many entities have a BoardComponent using cfold</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  numBoards <span class="ot">&lt;-</span> cfold (\c (<span class="dt">Board</span>{}) <span class="ot">-&gt;</span> c <span class="op">+</span> <span class="dv">1</span>) <span class="dv">0</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- We provide the count to renderBoard</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Also, we want to FOLD now, since we're iterating through boards</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  cfoldM_ (renderBoard numBoards) <span class="dv">0</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- We now know the total number of boards as well as the current board</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoard ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> <span class="dt">Int</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>renderBoard total i b <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Each of our cubes are now offset using a function we define below</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> <span class="fl">0.5</span>    <span class="dv">0</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> (<span class="op">-</span><span class="fl">0.5</span>) <span class="dv">0</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> <span class="fl">0.5</span> <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  RL.drawCube (addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> (<span class="op">-</span><span class="fl">0.5</span>) <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Return the next index (so we can track progress through iteration)</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Determine the origin of the board (4.5 = length of board (3) + padding (1.5))</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> offset <span class="ot">=</span> <span class="fu">fromIntegral</span> (total <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="fl">0.5</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        origin <span class="ot">=</span> <span class="dt">Vector3</span> (<span class="dt">CFloat</span> (<span class="fu">fromIntegral</span> i <span class="op">-</span> offset) <span class="op">*</span> <span class="fl">4.5</span>) <span class="fl">1.5</span> <span class="dv">0</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Convenience function for adding a vector to the origin, used above</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        offset p <span class="ot">=</span> addVectors p <span class="op">$</span> <span class="dt">Vector3</span> (<span class="dt">CFloat</span> origin) <span class="dv">0</span> <span class="dv">0</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        t <span class="ot">=</span> <span class="fl">0.05</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- Raylib bindings need love; we need to make a function for adding vectors</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="ot">addVectors ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Vector3</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>addVectors a b <span class="ot">=</span> <span class="dt">Vector3</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    (vector3'x a <span class="op">+</span> vector3'x b)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    (vector3'y a <span class="op">+</span> vector3'y b)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    (vector3'z a <span class="op">+</span> vector3'z b)</span></code></pre></div>
<p>The biggest change we’ve made here is the use of <code>cfold</code> and <code>cfoldM_</code>. Our first use of <code>cfold</code> is given a pure function that doesn’t use monads, therefore we use <code>cfold</code>. The second one does use monads, and since we don’t care about a return value we use <code>cfoldM_</code>. Folding is a generic way of doing things like accumulation or filtering; you iterate through the list as well as another parameter, be it a ‘count’, ‘total’ or an entirely different list. In this case, we used folds to firstly count the number of entities satisfying a condition (whether they had a <code>BoardComponent</code>), then we used another fold to iterate through the same set of entities, except this time we used the iteration value (<code>index</code>) as a way of knowing how far through we are, kind of like a <code>for</code> loop in imperative languages.</p>
<div class="warning infobox fill-horizontal">
<div class="header">
<span class="las la-exclamation-circle mr-3"></span>Warning - Using the entity ID
</div>
<p>An entity is just a wrapper for an integer value; in theory you could just use the entity’s ID itself to work out where the boards need to go. However, this will become problematic if you initialise other entities before or in the middle of your boards, as now your boards’ IDs won’t be sequential in the way you expect!</p>
</div>
<p>With that out of the way, let’s instantiate more entities!</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Let's make 3 boards!</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>newEntity_ newBoard</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>newEntity_ newBoard</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>newEntity_ newBoard</span></code></pre></div>
<p>Objective complete! Even though the components of each of these boards have the exact same state, the fact that there are multiple entities now reveals itself visually!</p>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668357984/blog/2022/11/13-11-2022_16_46_16_g6uf5j.png" title="Now we can render as many boards as we like, distributed along the x-axis." class="w-full object-cover" alt="Now we can render as many boards as we like, distributed along the x-axis." />
<div class="caption">
<p>Now we can render as many boards as we like, distributed along the x-axis.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/e71210405272674b49929c70cca0e2006df3888e" title="Notakto">Notakto</a>
</div>
</div>
</div>
</section>
<section id="board-state" class="article-section">
<h2><span>Board state</span><a href="#board-state" class="anchor las la-link" title="board-state"></a></h2>
<p>Time for the final piece of the puzzle: rendering a representation of what marks have been placed on each board! We’re almost there, I promise. This is more of the same kind of stuff.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoard ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> <span class="dt">Int</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>renderBoard total i b <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Render crosses as part of renderBoard</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- We provide the origin value as well as the component</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  renderCrosses origin b</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    RL.drawCube (addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> <span class="fl">0.5</span>    <span class="dv">0</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- &lt;...&gt;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Given an origin, render a cross for each cell</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="ot">renderCrosses ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>renderCrosses origin b <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- This function's job is to geometrically define what 'top left' etc means</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  renderCross origin (<span class="op">-</span><span class="dv">1</span>)   <span class="dv">1</span>  (_tl b)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">0</span>    <span class="dv">1</span>  (_tc b)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">1</span>    <span class="dv">1</span>  (_tr b)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  renderCross origin (<span class="op">-</span><span class="dv">1</span>)   <span class="dv">0</span>  (_ml b)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">0</span>    <span class="dv">0</span>  (_mc b)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">1</span>    <span class="dv">0</span>  (_mr b)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  renderCross origin (<span class="op">-</span><span class="dv">1</span>) (<span class="op">-</span><span class="dv">1</span>) (_bl b)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">0</span>  (<span class="op">-</span><span class="dv">1</span>) (_bc b)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">1</span>  (<span class="op">-</span><span class="dv">1</span>) (_br b)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Now we have an origin as well as a horizontal + vertical offset and a cell</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="ot">renderCross ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Cell</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- If the cell is empty, we just do nothing (pure nothingness, pretty metal!)</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>renderCross _ _ _ <span class="dt">Empty</span> <span class="ot">=</span> <span class="fu">pure</span> ()</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- If the cell is filled, we render a cross</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>renderCross origin i j <span class="dt">Filled</span> <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- We simply draw 2 lines, bottom left to top right...</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  RL.drawLine3D (f (<span class="op">-</span><span class="fl">0.4</span>) (<span class="op">-</span><span class="fl">0.4</span>)) (f <span class="fl">0.4</span> <span class="fl">0.4</span>) RL.red</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- ... and then bottom right to top left</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  RL.drawLine3D (f <span class="fl">0.4</span> (<span class="op">-</span><span class="fl">0.4</span>)) (f (<span class="op">-</span><span class="fl">0.4</span>) <span class="fl">0.4</span>) RL.red</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- We have some helper values here, center being the center of the cell</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- calculated using the origin and offsets</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> center <span class="ot">=</span> addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> (<span class="dt">CFloat</span> i) (<span class="dt">CFloat</span> j) <span class="dv">0</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- As well as a helper function to create start and end points</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>        f x y <span class="ot">=</span> addVectors center <span class="op">$</span> <span class="dt">Vector3</span> x y <span class="dv">0</span></span></code></pre></div>
<p>Ready to test it out? Let’s ammend our initialisation for one of the boards:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  newEntity_ <span class="op">$</span> <span class="dt">Board</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Filled</span> <span class="dt">Empty</span> <span class="dt">Empty</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  newEntity_ newBoard</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  newEntity_ newBoard</span></code></pre></div>
<p>And now we see that the first board has the top-left cell filled! We can now visualise both the amount of boards and the content of each one! Chapter over!</p>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668362726/blog/2022/11/13-11-2022_18_05_04_kqweul.png" title="We can now visualise the state of each board." class="w-full object-cover" alt="We can now visualise the state of each board." />
<div class="caption">
<p>We can now visualise the state of each board.</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/e71210405272674b49929c70cca0e2006df3888e" title="Notakto">Notakto</a>
</div>
</div>
</div>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/e71210405272674b49929c70cca0e2006df3888e">here</a>.</p>
</div>
</section>
</section>
<section id="making-moves" class="article-section">
<h1><span>Making moves</span><a href="#making-moves" class="anchor las la-link" title="making-moves"></a></h1>
<section id="preparing-the-raycast" class="article-section">
<h2><span>Preparing the raycast</span><a href="#preparing-the-raycast" class="anchor las la-link" title="preparing-the-raycast"></a></h2>
<p>Okay, it’s time to speed up and do some gameplay code. In order to make moves, players will need to shoot a ray out from the camera into the boards so that they can precisely specify where they want to place their cross. Let’s start by adding a new component responsible for storing the player’s current aim. We don’t have to give it a default value as it’ll be written during our update frame anyway.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- New component to add (Types.hs) and add to World</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">PlayerAimComponent</span> <span class="ot">=</span> <span class="dt">Aim</span> <span class="dt">RL.Ray</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- New update system to add (Lib.hs) and be called from update system</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ot">handlePlayerAim ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>handlePlayerAim <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Determine window size so that we can cast from center of screen</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  windowWidth <span class="ot">&lt;-</span> liftIO RL.getScreenWidth</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  windowHeight <span class="ot">&lt;-</span> liftIO RL.getScreenHeight</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> <span class="dt">Retrieve</span> the camera (will have just been updated)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> camera <span class="ot">&lt;-</span> get global</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Create a ray to be cast later</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  ray <span class="ot">&lt;-</span> liftIO <span class="op">$</span> RL.getMouseRay (<span class="dt">RL.Vector2</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">CFloat</span> <span class="op">$</span> <span class="fu">fromIntegral</span> windowWidth <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">CFloat</span> <span class="op">$</span> <span class="fu">fromIntegral</span> windowHeight <span class="op">/</span> <span class="dv">2</span>)) camera</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Aim</span> ray</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- New render system to add (Rendering.hs) and be called from render system</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="ot">renderAimRay ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>renderAimRay <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Retrieve player aim component</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Aim</span> ray <span class="ot">&lt;-</span> get global</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Determine endpoints of a line to draw</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Note that we slightly offset the start location since we are drawing</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- from the camera, and if we didn't offset then the line would appear</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- as a dot!</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lineStart <span class="ot">=</span> addVectors (RL.ray'position ray) (<span class="dt">Vector3</span> <span class="dv">0</span> (<span class="op">-</span><span class="fl">0.05</span>) <span class="dv">0</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>      lineEnd <span class="ot">=</span> addVectors (RL.ray'position ray) <span class="op">$</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        multiplyVector (RL.ray'direction ray) <span class="dv">10</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Render the line</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> RL.drawLine3D lineStart lineEnd RL.yellow</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co">-- New utility function</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="ot">multiplyVector ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Vector3</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>multiplyVector a b <span class="ot">=</span> <span class="kw">let</span> b' <span class="ot">=</span> <span class="dt">CFloat</span> b <span class="kw">in</span> <span class="dt">Vector3</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  (vector3'x a <span class="op">*</span> b')</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  (vector3'y a <span class="op">*</span> b')</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  (vector3'z a <span class="op">*</span> b')</span></code></pre></div>
<p>We have momentum now! We haven’t done anything gameplay related really yet, but we’re blasting through the basics and now we’re ready to try and cherry-pick a cell from a board. This yellow line will be really helpful for making sure that the selected cell we’re going to calculate is in the approximate area of the ray.</p>
<p>This is where having each cross as its own entity has a benefit; each cross could easily check if it the raycast strikes it and our picking system would be done in a matter of minutes. However, the drawbacks of this is the task of connecting it back to the board and making changes to the game state. Instead, we’re going to see if the raycast collides with the board, and use the position it strikes the board to determine which cell the player is aiming at.</p>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/d85cd87ad2ebe77e14c572f1db43fec0c9120059">here</a>.</p>
</div>
</section>
<section id="identifying-the-looked-at-cell" class="article-section">
<h2><span>Identifying the looked-at cell</span><a href="#identifying-the-looked-at-cell" class="anchor las la-link" title="identifying-the-looked-at-cell"></a></h2>
<p>I knew it was coming; the problem with writing the blog post as I go means that I get stuff wrong. I initially thought it would be a good idea to simply count the entities and render the board in a position dependent on it’s index, however this is just going to be so annoying to calculate each time. That’s okay though, as both Haskell and Apecs are really easy to experiment with and try new things. Here’s a quick correction to our project:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- New component for tracking positions in 3D space</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">PositionComponent</span> <span class="ot">=</span> <span class="dt">Position</span> <span class="dt">RL.Vector3</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Initialisation system for automatically creating n boards across the x axis</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note: Thanks to our position component, you could create all sorts of patterns!</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ot">createBoards ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>createBoards n <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- forM_ is standard library, it's equivalent to flip mapM</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Also notice that to create an entity with multiple components we use a tuple</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  forM_ positions <span class="op">$</span> \p <span class="ot">-&gt;</span> newEntity_ (newBoard, <span class="dt">Position</span> p)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> newBoard <span class="ot">=</span> <span class="dt">Board</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span> <span class="dt">Empty</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- List comprehension to dynamically generate a list of x coordinates</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        positions <span class="ot">=</span> [<span class="dt">Vector3</span> x' <span class="fl">1.5</span> <span class="dv">0</span> <span class="op">|</span> x <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="op">..</span>n <span class="op">-</span> <span class="dv">1</span>],</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> x' <span class="ot">=</span> (<span class="fu">fromIntegral</span> x <span class="op">-</span> (<span class="fu">fromIntegral</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span>)) <span class="op">*</span> <span class="fl">4.5</span>]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- Forget cfoldM_, we're back to cmapM_</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoards ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>renderBoards <span class="ot">=</span> cmapM_ renderBoard</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co">-- Notice the tuple - this is how you select entities that contain both components</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note: You can use the 'Not' type to ensure the entity DOES NOT have that type</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoard ::</span> (<span class="dt">BoardComponent</span>, <span class="dt">PositionComponent</span>) <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>renderBoard (b, <span class="dt">Position</span> p) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  renderCrosses p b</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    RL.drawCube (addVectors p <span class="op">$</span> <span class="dt">Vector3</span> <span class="fl">0.5</span>    <span class="dv">0</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    RL.drawCube (addVectors p <span class="op">$</span> <span class="dt">Vector3</span> (<span class="op">-</span><span class="fl">0.5</span>) <span class="dv">0</span> <span class="dv">0</span>) t <span class="dv">3</span> t RL.white</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    RL.drawCube (addVectors p <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> <span class="fl">0.5</span> <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    RL.drawCube (addVectors p <span class="op">$</span> <span class="dt">Vector3</span> <span class="dv">0</span> (<span class="op">-</span><span class="fl">0.5</span>) <span class="dv">0</span>) <span class="dv">3</span> t t RL.white</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> t <span class="ot">=</span> <span class="fl">0.05</span></span></code></pre></div>
<p>This is where things get tricky… I’ve actually had to file a <a href="https://github.com/Anut-py/h-raylib/issues/5">bug report</a> since the raycasting and collision of Raylib don’t seem to be working great. It seems that data that we’re receiving isn’t what we expect and is slightly unreliable unless we do some IO before accessing it. Raylib wasn’t written in Haskell, and so even though our programming can easily be reasoned about, there’s a bit of a grey area where bindings to libraries written in other languages are. For now though, I’m just going to pretend the bug doesn’t exist and try to implement more of the program.</p>
<p>Before we continue, we need to ask ourselves what we actually want to do. Right now, my goal is to make it so that when you aim at a cell, we see a ‘ghost’ of a cross that will appear if you hit the left mouse button. The biggest question is, how do we want to store this bit of state?</p>
<ol type="1">
<li>We could change our <code>Cell</code> type to be either <code>Empty | Filled | Chosen</code>, however that will require us to make sure that only one cell is chosen at most, which is more work.</li>
<li>We could specify a new variable on the <code>BoardComponent</code> to keep track on which cell is chosen, but that would mean that we could have multiple chosen cells across multiple boards.</li>
<li>We could update the <code>PlayerAimComponent</code> to contain both the ray and the looked-at cell — while this would work, it would be assuming that we’re only interested in players looking at cells, and wouldn’t be very good if your game had multiple things players could interact with.</li>
<li>We could try to avoid writing state altogether, but this would mean that every cell will need to crunch the numbers to work out if you’re looking at it <em>every rendering loop</em>. This would also mean that we have to test cells in isolation, meaning that there could be a situation where you’re technically looking at multiple cells at once.</li>
</ol>
<p>Isn’t gamedev fun? I believe that I’m going to go for <strong>option 3</strong>. Note that if you were doing a look-at system in a different type of game, you’d most likely just record which <code>Entity</code> you’re looking at. The only reason we are in this scenario is because we avoided making crosses be their own <code>Entity</code>.</p>
<div class="help infobox fill-horizontal">
<div class="header">
<span class="las la-question-circle mr-3"></span>Thinking of alternatives
</div>
<p>If you are looking to improve yourself as a programmer it’s always a good idea to think about all the different ways you could solve a problem <em>before</em> you get started. You (or your team) could begin to spot glaring issues before they manifest, and they also reassure you that if things go wrong you have other ways of solving things. Of course, don’t spend <em>ages</em> planning as you can’t always capture every potential problem without giving things a go.</p>
<p>If you’re struggling with thinking of approaches (and believe me, there are <em>always</em> better ways of writing things and numerous things that could be improved), try some of the following methods:</p>
<ul>
<li><p><strong>Start making a list —</strong> Sometimes, by simply writing ‘1.’ and arranging your thoughts into a list, you naturally start thinking of new entries to pad it out. I literally did this in the section above! Give yourself a space to prove to yourself you can do this!</p></li>
<li><p><strong>Take your initial approach and make small adjustments —</strong> Sometimes you can quickly create alternative approaches by simply taking your first idea and altering it slightly; option 2 could be the same as option 1 with an addition or exception. For example, if your idea was to add a new variable to something, maybe consider if it could also be added somewhere else or added in a different way such that it has multiple uses.</p></li>
<li><p><strong>Pretend to be a super-villain —</strong> Let’s say that it’s become your job to sabotage your code in some way, whether that’s by misusing the code or using the application in unintended ways. What would you do, and what kinds of things could you break? Now come back to reality and think about the likelihood of any of those scenarios, the risks they present and the cost of prevention.</p></li>
<li><p><strong>Consider not doing it —</strong> Lack of action is itself an action, and so questionning whether you need to implement your feature in the first place isn’t a bad question to ask. Sometimes it exposes how many drawbacks there are versus the benefits, and perhaps what you might consider a workaround turns into one of your alternative approaches. What is the requirement that is driving this decision? If there isn’t one, then maybe we need to understand our requirements first.</p></li>
</ul>
</div>
<p>Huzzah, after a few days that <a href="https://github.com/Anut-py/h-raylib/issues/5">bug</a> was fixed! Let’s get on with approach number three:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- New data type representing the player's current looked-at cell</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">LookAtTarget</span> <span class="ot">=</span> <span class="dt">NoTarget</span> <span class="op">|</span> <span class="dt">Target</span> <span class="dt">Entity</span> <span class="dt">Int</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Update the aim component to make use of our new type</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">PlayerAimComponent</span> <span class="ot">=</span> <span class="dt">Aim</span> <span class="dt">RL.Ray</span> <span class="dt">LookAtTarget</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Update the player aim function to calculate the currently looked-at cell</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="ot">handlePlayerAim ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>handlePlayerAim <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  windowWidth <span class="ot">&lt;-</span> liftIO RL.getScreenWidth</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  windowHeight <span class="ot">&lt;-</span> liftIO RL.getScreenHeight</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> camera <span class="ot">&lt;-</span> get global</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  ray <span class="ot">&lt;-</span> liftIO <span class="op">$</span> RL.getMouseRay (<span class="dt">RL.Vector2</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">CFloat</span> <span class="op">$</span> <span class="fu">fromIntegral</span> windowWidth <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">CFloat</span> <span class="op">$</span> <span class="fu">fromIntegral</span> windowHeight <span class="op">/</span> <span class="dv">2</span>)) camera</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Use the ray we generated to find a target</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> cfoldM (findLookAtTarget ray) <span class="dt">NoTarget</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Aim</span> ray target</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- Look for closest board that the player is looking at</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="ot">findLookAtTarget ::</span> <span class="dt">RL.Ray</span> <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>                    (<span class="dt">BoardComponent</span>, <span class="dt">PositionComponent</span>, <span class="dt">Entity</span>) <span class="ot">-&gt;</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">System</span> <span class="dt">World</span> <span class="dt">LookAtTarget</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>findLookAtTarget ray target (_, <span class="dt">Position</span> p, e) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- If our raycast hits the current board</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> RL.rayCollision'hit hitInfo <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">then</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Check if this new target is closer than our current target</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    getClosestTarget ray target <span class="op">$</span> <span class="dt">Target</span> e (findCell hitPos)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Otherwise, use the current best target</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> target</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Determine where to place the hitbox for raycast, and check hit location</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> from <span class="ot">=</span> addVectors p <span class="op">$</span> <span class="dt">Vector3</span> (<span class="op">-</span><span class="fl">1.5</span>) (<span class="op">-</span><span class="fl">1.5</span>) (<span class="op">-</span><span class="fl">0.05</span>)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        to <span class="ot">=</span> addVectors p <span class="op">$</span> <span class="dt">Vector3</span> <span class="fl">1.5</span> <span class="fl">1.5</span> <span class="fl">0.05</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        hitInfo <span class="ot">=</span> RL.getRayCollisionBox ray <span class="op">$</span> <span class="dt">RL.BoundingBox</span> from to</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        hitPos <span class="ot">=</span> subtractVectors (RL.rayCollision'point hitInfo) p</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="co">-- Checks two targets and returns the closest one</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="ot">getClosestTarget ::</span> <span class="dt">RL.Ray</span> <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">System</span> <span class="dt">World</span> <span class="dt">LookAtTarget</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="co">-- If both variables are valid targets</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>getClosestTarget ray a<span class="op">@</span>(<span class="dt">Target</span> eA _) b<span class="op">@</span>(<span class="dt">Target</span> eB _) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Note: We could have passed in the position of the prospective target,</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- but felt a bit rubbish today and just thought I'd keep it simple</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Position</span> posA <span class="ot">&lt;-</span> get eA</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Position</span> posB <span class="ot">&lt;-</span> get eB</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Calculate distances to ray origin</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> p <span class="ot">=</span> RL.ray'position ray</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>      distA <span class="ot">=</span> magnitudeVector <span class="op">$</span> subtractVectors posA p</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>      distB <span class="ot">=</span> magnitudeVector <span class="op">$</span> subtractVectors posB p</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Return closest target</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> <span class="kw">if</span> distA <span class="op">&lt;=</span> distB <span class="kw">then</span> a <span class="kw">else</span> b</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="co">-- Handle cases where invalid targets present</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>getClosestTarget _ a <span class="dt">NoTarget</span> <span class="ot">=</span> <span class="fu">pure</span> a</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>getClosestTarget _ <span class="dt">NoTarget</span> b <span class="ot">=</span> <span class="fu">pure</span> b</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co">-- Takes a hit position and determines the looked-at cell</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="ot">findCell ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>findCell (<span class="dt">Vector3</span> x y _)</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> y <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="ot">=</span> findCol <span class="dv">0</span> <span class="dv">1</span> <span class="dv">2</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> y <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span> <span class="ot">=</span> findCol <span class="dv">6</span> <span class="dv">7</span> <span class="dv">8</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> findCol <span class="dv">3</span> <span class="dv">4</span> <span class="dv">5</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> findCol left center right</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> x <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span> <span class="ot">=</span> left</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="ot">=</span> right</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> center</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="co">-- Another utility function to get the length / magnitude of a vector3</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="ot">magnitudeVector ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Float</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>magnitudeVector (<span class="dt">Vector3</span> x y z) <span class="ot">=</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> <span class="dt">CFloat</span> f <span class="ot">=</span> <span class="fu">sqrt</span> <span class="op">$</span> (x <span class="op">*</span> x) <span class="op">+</span> (y <span class="op">*</span> y) <span class="op">+</span> (z <span class="op">*</span> z) <span class="kw">in</span> f</span></code></pre></div>
<p>Our <code>PlayerAimComponent</code> is now primed! Let’s render it to prove to ourselves that we’ve completed a major hurdle. As an extra spin, I only want to render these markings if the cell isn’t already filled. We’re going to be pretty much updating all of our rendering logic to accept the <code>LookAtTarget</code> as a new parameter:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoards ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>renderBoards <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Give the target from our aim component to renderBoard</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Aim</span> _ target <span class="ot">&lt;-</span> get global</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  cmapM_ (renderBoard target)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Accept a new parameter and forward it to renderCrosses</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="ot">renderBoard ::</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span> (<span class="dt">BoardComponent</span>, <span class="dt">PositionComponent</span>, <span class="dt">Entity</span>) <span class="ot">-&gt;</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>               <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>renderBoard target (b, <span class="dt">Position</span> p, e) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  renderCrosses p (b, e) target</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- ...</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Each cross now has an index - we need to check if each cross is being</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- aimed at and pass that to renderCross. We have a new function to handle</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- that: isAimingAtCell</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="ot">renderCrosses ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> (<span class="dt">BoardComponent</span>, <span class="dt">Entity</span>) <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>renderCrosses origin (b, e) target <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  renderCross origin (<span class="op">-</span><span class="dv">1</span>)   <span class="dv">1</span>  (_tl b) (isAimingAtCell e <span class="dv">0</span> target)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  renderCross origin   <span class="dv">0</span>    <span class="dv">1</span>  (_tc b) (isAimingAtCell e <span class="dv">1</span> target)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- ...</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- Checks if the target is valid, and returns true if entity and cell matches</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="ot">isAimingAtCell ::</span> <span class="dt">Entity</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>isAimingAtCell (<span class="dt">Entity</span> e) i (<span class="dt">Target</span> (<span class="dt">Entity</span> e') i') <span class="ot">=</span> e <span class="op">==</span> e' <span class="op">&amp;&amp;</span> i <span class="op">==</span> i'</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>isAimingAtCell _ _ _ <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- This function has another pattern to it depending on whether its aimed at</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="ot">renderCross ::</span> <span class="dt">Vector3</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">Cell</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- Empty, non-aimed at cells have nothing rendered</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>renderCross _ _ _ <span class="dt">Empty</span> <span class="dt">False</span> <span class="ot">=</span> <span class="fu">pure</span> ()</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="co">-- Filled cells are rendered as crosses, regardless of aim</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>renderCross origin i j <span class="dt">Filled</span> _ <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  RL.drawLine3D (f (<span class="op">-</span><span class="fl">0.4</span>) (<span class="op">-</span><span class="fl">0.4</span>)) (f <span class="fl">0.4</span> <span class="fl">0.4</span>) RL.red</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  RL.drawLine3D (f <span class="fl">0.4</span> (<span class="op">-</span><span class="fl">0.4</span>)) (f (<span class="op">-</span><span class="fl">0.4</span>) <span class="fl">0.4</span>) RL.red</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> center <span class="ot">=</span> addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> (<span class="dt">CFloat</span> i) (<span class="dt">CFloat</span> j) <span class="dv">0</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        f x y <span class="ot">=</span> addVectors center <span class="op">$</span> <span class="dt">Vector3</span> x y <span class="dv">0</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="co">-- Otherwise, if we have an empty cell that's aimed at, render a circle</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>renderCross origin i j <span class="dt">Empty</span> <span class="dt">True</span> <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    RL.drawCircle3D center <span class="fl">0.4</span> (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">0</span> RL.yellow</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> center <span class="ot">=</span> addVectors origin <span class="op">$</span> <span class="dt">Vector3</span> (<span class="dt">CFloat</span> i) (<span class="dt">CFloat</span> j) <span class="dv">0</span></span></code></pre></div>
<p>And with this, it’s game over! From now on it’s mostly gameplay code, and hopefully everything we do can is reflected by our rendering! Well done if you’ve made it this far; like with most games, the rendering can easily eat up a lot of our time. I’m sure the only rendering we’ll do from now on will be trivial.</p>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668959570/blog/2022/11/20-11-2022_15_52_00_njlrim.png" title="We can now aim at cells, rendering the game is pretty much complete!" class="w-full object-cover" alt="We can now aim at cells, rendering the game is pretty much complete!" />
<div class="caption">
<p>We can now aim at cells, rendering the game is pretty much complete!</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/38d84524d96e21050e8dca6f1ec944f675d966d4" title="Notakto">Notakto</a>
</div>
</div>
</div>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/38d84524d96e21050e8dca6f1ec944f675d966d4">here</a>.</p>
</div>
</section>
<section id="placing-crosses-dynamically" class="article-section">
<h2><span>Placing crosses dynamically</span><a href="#placing-crosses-dynamically" class="anchor las la-link" title="placing-crosses-dynamically"></a></h2>
<p>I don’t know about you, but I really hate the fact that this blog post so far has been mostly rendering! Isn’t this meant to be a blog about <a href="https://hackage.haskell.org/package/apecs">Apecs</a>?! Well, let’s fix that by finishing our game and coming up with more entities, components and systems! First up are a set of systems to handle playing the game.</p>
<p>So far, our game has been doing all of our systems every single frame — we need to have some logic ran conditionally:</p>
<ul>
<li><strong>Obviously, we need to place crosses when we click:</strong> We wouldn’t want this running every frame as the game would be unplayable!</li>
<li><strong>When we get three-in-a-row we need to kill the board:</strong> The state of the game only changes when moves are made, so this can also be ran on left click; it would be redundant otherwise!</li>
<li><strong>We need to check for game-over when a board is killed:</strong> When there are no boards remaining, the current player is the loser and the winner is decided. Again, this relies on state being changed, so we’re slowly moving away from frames to turns.</li>
<li><strong>We need to switch players:</strong> We have no concept of players yet, but when we do, we will be switching who’s turn it is as well as incrementing stats of whatever sort after checking for game-over and it being decided that play should be continued.</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ot">update ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>update <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  updateCamera</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  handlePlayerAim</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- After aiming, we want to handle clicking</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  clicked <span class="ot">&lt;-</span> liftIO <span class="op">$</span> RL.isMouseButtonPressed <span class="dv">0</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  when clicked <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    handleLeftClick</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- Handles everything that may happen following a left-click</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="ot">handleLeftClick ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>handleLeftClick <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Try and place a cross, and print a message when successful</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  moveMade <span class="ot">&lt;-</span> tryPlaceCross</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  when moveMade <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Note: This is where we'll check for game-over later</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Move Made!&quot;</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- This system returns true if a new cross is placed on the board</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="ot">tryPlaceCross ::</span> <span class="dt">System</span> <span class="dt">World</span> <span class="dt">Bool</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>tryPlaceCross <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Get the player's target</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Aim</span> _ target <span class="ot">&lt;-</span> get global</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> target <span class="kw">of</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Do nothing if there is no target</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NoTarget</span> <span class="ot">-&gt;</span> <span class="fu">pure</span> <span class="dt">False</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- If there is a target, try to mutate the state of the board</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Target</span> e i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>      board <span class="ot">&lt;-</span> get e</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> getCell board i <span class="op">==</span> <span class="dt">Empty</span> <span class="kw">then</span> <span class="kw">do</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- We set the component on the entity here directly,</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- if you're doing this on lots of entities you should be using cmap</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>        set e <span class="op">$</span> setCell board i <span class="dt">Filled</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pure</span> <span class="dt">True</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pure</span> <span class="dt">False</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a><span class="co">-- Convenience function for retrieving a cell by-index</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="ot">getCell ::</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Cell</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>getCell b <span class="dv">0</span> <span class="ot">=</span>_tl b</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>getCell b <span class="dv">1</span> <span class="ot">=</span>_tc b</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>getCell b <span class="dv">2</span> <span class="ot">=</span>_tr b</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- ...</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="co">-- Convenience function for setting a cell by-index</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="ot">setCell ::</span> <span class="dt">BoardComponent</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Cell</span> <span class="ot">-&gt;</span> <span class="dt">BoardComponent</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>setCell b <span class="dv">0</span> c <span class="ot">=</span> b { _tl <span class="ot">=</span> c }</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>setCell b <span class="dv">1</span> c <span class="ot">=</span> b { _tc <span class="ot">=</span> c }</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>setCell b <span class="dv">2</span> c <span class="ot">=</span> b { _tr <span class="ot">=</span> c }</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="co">-- ...</span></span></code></pre></div>
<p>If you give the game a try now, you’ll be happy to see that, as expected, we can now place crosses when we click the mouse button. We have a lot of momentum now, let’s not stop here and move onto finishing the game loop itself!</p>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/c740a55ee514d1d7d93dda38f4cdfd9a2a079fcb">here</a>.</p>
</div>
</section>
<section id="killing-boards" class="article-section">
<h2><span>Killing boards</span><a href="#killing-boards" class="anchor las la-link" title="killing-boards"></a></h2>
<p>The rules of Notakto state that when a three-in-a-row is detected, a board is declared ‘dead’ and can no longer be played on; when there are no boards remaining, the game is over and the current player loses. Killing boards is just as important as making moves on a single board, however fortunately for us this won’t be difficult at all to pull off with the tools we have.</p>
<ol type="1">
<li><strong>We will create a new component that we attach to boards to render them dead:</strong> We <em>could</em> calculate if a board is dead every time we need to know, but this will add up especially if we want to render this somehow. If we use a component, we can trivially iterate through alive and dead boards.</li>
<li><strong>We will count the dead boards:</strong> We will use <code>cfold</code> to count the number of boards that are alive, and if this number is 0 we will declare the game to be over.</li>
<li><strong>We will <em>not</em> render dead boards:</strong> I’m stick of doing rendering in this tutorial. I’m going to force the players to manually check the state of the board for whether they’re playable — it’s not a <em>missing feature</em>, it’s a <strong><em>skill check</em></strong>.</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- New component with a unary data constructor</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note: To test for absense, we will be using the type Not DeathComponent</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">DeathComponent</span> <span class="ot">=</span> <span class="dt">Dead</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- New system that will kill any boards with three-in-a-row and</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- then return if there's a game-over</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="ot">checkForGameOver ::</span> <span class="dt">System</span> <span class="dt">World</span> <span class="dt">Bool</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>checkForGameOver <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Map a function onto all entities with boards, killing them if possible</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  cmap tryKillBoard</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Count the number of boards that are alive (lack of death component)</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span><span class="ot"> countAlive ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">BoardComponent</span>, <span class="dt">Not</span> <span class="dt">DeathComponent</span>) <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      countAlive c (_, _) <span class="ot">=</span> c <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Perform the counting and return true if all boards dead</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  count <span class="ot">&lt;-</span> cfold countAlive <span class="dv">0</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> count <span class="op">&lt;=</span> <span class="dv">0</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- Note the type signature; we use 'Not' to exclude dead boards</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- Another thing to note is that we return 'Maybe DeathComponent',</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co">-- this hints that we may or may not be adding a component to the entity</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="ot">tryKillBoard ::</span> (<span class="dt">BoardComponent</span>, <span class="dt">Not</span> <span class="dt">DeathComponent</span>) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">DeathComponent</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Just Dead will add the DeathComponent, Nothing will add nothing</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>tryKillBoard (bc, _) <span class="ot">=</span> <span class="kw">if</span> check cellCombos <span class="kw">then</span> <span class="dt">Just</span> <span class="dt">Dead</span> <span class="kw">else</span> <span class="dt">Nothing</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Fold through a list of combos and check if any are threes-in-a-row</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> check <span class="ot">=</span> <span class="fu">foldl</span> (\dead (a, b, c) <span class="ot">-&gt;</span> dead <span class="op">||</span> checkCombo a b c) <span class="dt">False</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Check if all cells in a combination are filled, meaning a win</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        checkCombo a b c <span class="ot">=</span> checkCell a <span class="op">&amp;&amp;</span> checkCell b <span class="op">&amp;&amp;</span> checkCell c</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        checkCell c <span class="ot">=</span> getCell bc c <span class="op">==</span> <span class="dt">Filled</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="co">-- A list of all cell combinations in index form (to be used with getCell)</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="ot">cellCombos ::</span> [(<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)]</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>cellCombos <span class="ot">=</span> [</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Horizontal</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>),</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Vertical</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">6</span>),</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>),</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">8</span>),</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Diagonal</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  ]</span></code></pre></div>
<p>You may think that’s it, but now we need to sprinkle mention of the <code>DeathComponent</code> to places where we don’t want interactions with dead boards. After looking through the code, I can only think of one place, but you might have more:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ot">findLookAtTarget ::</span> <span class="dt">RL.Ray</span> <span class="ot">-&gt;</span> <span class="dt">LookAtTarget</span> <span class="ot">-&gt;</span> (<span class="dt">BoardComponent</span>,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">PositionComponent</span>, <span class="dt">Not</span> <span class="dt">DeathComponent</span>, <span class="dt">Entity</span>) <span class="ot">-&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">System</span> <span class="dt">World</span> <span class="dt">LookAtTarget</span></span></code></pre></div>
<p>If you want to special rendering for dead boards, now is the time! You might even want to update the death component to contain data regarding the winning combination for easy access!</p>
<p>Let’s now use our new system in the game and print a message if the game is over:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ot">handleLeftClick ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>handleLeftClick <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  moveMade <span class="ot">&lt;-</span> tryPlaceCross</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  when moveMade <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    isGameOver <span class="ot">&lt;-</span> checkForGameOver</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> isGameOver <span class="kw">then</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>      liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Game over!&quot;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>      liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Next turn!&quot;</span></span></code></pre></div>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668969610/blog/2022/11/20-11-2022_18_39_47_svchfm.png" title="We can now detect a game over --- it's all coming together!" class="w-full object-cover" alt="We can now detect a game over --- it's all coming together!" />
<div class="caption">
<p>We can now detect a game over — it’s all coming together!</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/e6f589f3661fd8070ef977021174edb3ca808188" title="Notakto">Notakto</a>
</div>
</div>
</div>
</section>
<section id="restarting-the-game" class="article-section">
<h2><span>Restarting the game</span><a href="#restarting-the-game" class="anchor las la-link" title="restarting-the-game"></a></h2>
<p>Before we finish this chapter, let’s handle restarting the game as it’s very related to the previous section! Firstly, even though we named the function <code>checkForGameOver</code>, this function is also responsible for killing boards. Let’s do this elsewhere so that this function is purely a check, this way we can reuse it without worry!</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ot">handleLeftClick ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>handleLeftClick <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Check if the game is already over before making a move</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  needsRestart <span class="ot">&lt;-</span> checkForGameOver</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Only make moves if the game isn't over</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="fu">not</span> needsRestart <span class="kw">then</span> <span class="kw">do</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    moveMade <span class="ot">&lt;-</span> tryPlaceCross</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    when moveMade <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      cmap tryKillBoard</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>      isGameOver <span class="ot">&lt;-</span> checkForGameOver</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> isGameOver <span class="kw">then</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Game over!&quot;</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Next turn!&quot;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Otherwise, restart the game</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    newGame</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="st">&quot;Restarted game!&quot;</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- New initialisation function that deletes all entities</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="ot">newGame ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>newGame <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  cmapM_ deleteBoard</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  createBoards <span class="dv">3</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- You can't really 'delete' entities in Apecs since entities are just ints;</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- you have to delete their components. We use a convenience function.</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> deleteBoard (<span class="dt">Board</span>{}, e) <span class="ot">=</span> destroyEntity e</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- We make a type combining all types for miscellaneous use</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">AllComponents</span> <span class="ot">=</span> (<span class="dt">PositionComponent</span>, <span class="dt">CameraComponent</span>, <span class="dt">BoardComponent</span>,</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">DeathComponent</span>, <span class="dt">PlayerAimComponent</span>)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="co">-- Trivial deletion function</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="ot">destroyEntity ::</span> <span class="dt">Entity</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>destroyEntity e <span class="ot">=</span> destroy e (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="dt">AllComponents</span>)</span></code></pre></div>
<p>Deletion in Apecs can be a little tricky, but as the author writes in <a href="https://github.com/jonascarpay/apecs/issues/13#issuecomment-392630286">this comment</a>, as long as we obliterate any components on an entity it will stop having any effect on the application!</p>
<div class="caption-frame apply-shadow">
<blockquote>
<p>You can’t destroy an entity, you can only destroy each of its components. An Entity is just an integer that may or may not some components associated with it. There is currently no way to destroy all components for a given entity.</p>
<p>I might add some support for this in the future, but if you use type synonyms for common tuples, it shouldn’t be an issue.</p>
</blockquote>
<div class="caption">
<p>Apecs author Jonascarpay talking about deletion in Apecs.</p>
<div class="caption-source">
<a href="https://github.com/jonascarpay/apecs/issues/13#issuecomment-392630286" title="Github">Github</a>
</div>
</div>
</div>
<p>Well done, you can now play, complete and restart games! If you were to track turns and play with a friend, you could call this the end and enjoy it! There’s one final thing I want to do before I call quits and leave the rest up to you: creating the notion of players!</p>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the corresponding commit for the previous section can be found <a href="https://github.com/Ashe/Notakto/tree/63f686a4ae9fcba150c04b0605c2b4d781af2012">here</a>.</p>
</div>
</section>
<section id="making-players-take-turns" class="article-section">
<h2><span>Making players take turns</span><a href="#making-players-take-turns" class="anchor las la-link" title="making-players-take-turns"></a></h2>
<p>The game is essentially complete, but we don’t really track the current player anywhere! I’m going to leave out the rendering and purely focus on the components and systems as I’m sure anyone reading this can fill in the gaps.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- New component for tracking the current player</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">PlayerComponent</span> <span class="ot">=</span> <span class="dt">Red</span> <span class="op">|</span> <span class="dt">Blue</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Initialise the current player when we initialise the camera</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>set global <span class="op">$</span> (<span class="dt">Camera</span> camera, <span class="dt">Red</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Switch players when a non-winning move is made</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="ot">handleLeftClick ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>handleLeftClick <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Grab current player</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  player <span class="ot">&lt;-</span> get global</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  needsRestart <span class="ot">&lt;-</span> checkForGameOver</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="fu">not</span> needsRestart <span class="kw">then</span> <span class="kw">do</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    moveMade <span class="ot">&lt;-</span> tryPlaceCross</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    when moveMade <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>      cmap tryKillBoard</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      isGameOver <span class="ot">&lt;-</span> checkForGameOver</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> isGameOver <span class="kw">then</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Print that the current player lost</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Game over! &quot;</span> <span class="op">++</span> <span class="fu">show</span> player <span class="op">++</span> <span class="st">&quot; loses!&quot;</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- Swap players and print who's turn it is</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nextPlayer <span class="ot">=</span> <span class="kw">if</span> player <span class="op">==</span> <span class="dt">Red</span> <span class="kw">then</span> <span class="dt">Blue</span> <span class="kw">else</span> <span class="dt">Red</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        set global nextPlayer</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;It's &quot;</span> <span class="op">++</span> <span class="fu">show</span> nextPlayer <span class="op">++</span> <span class="st">&quot;'s turn!&quot;</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    newGame</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Restarted game! It's &quot;</span> <span class="op">++</span> <span class="fu">show</span> player <span class="op">++</span> <span class="st">&quot;'s turn!&quot;</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- Change colour of things for different players</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="ot">playerColour ::</span> <span class="dt">PlayerComponent</span> <span class="ot">-&gt;</span> <span class="dt">RL.Color</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>playerColour <span class="dt">Red</span> <span class="ot">=</span> RL.red</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>playerColour <span class="dt">Blue</span> <span class="ot">=</span> RL.skyBlue</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example of changing colour of ray to suit player</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="ot">renderAimRay ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>renderAimRay <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Notice that we aren't annotating the type for player; we infer it!</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  (<span class="dt">Aim</span> ray _, player) <span class="ot">&lt;-</span> get global</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lineStart <span class="ot">=</span> addVectors (RL.ray'position ray) (<span class="dt">Vector3</span> <span class="dv">0</span> (<span class="op">-</span><span class="fl">0.05</span>) <span class="dv">0</span>)</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>      lineEnd <span class="ot">=</span> addVectors (RL.ray'position ray) <span class="op">$</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>        multiplyVector (RL.ray'direction ray) <span class="dv">10</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> RL.drawLine3D lineStart lineEnd <span class="op">$</span> playerColour player</span></code></pre></div>
<p>Firstly, how cool is it that we can add features to the game this easily when using both Haskell and Apecs? It’s really during the iterations on your project where Haskell shines, and Apecs complements it perfectly. Secondly, notice that <strong>we didn’t annotate</strong> the type for <code>player</code> — again, thanks to Haskell, we can infer the types of components from their <em>usage</em>, so as long as you use your components for things you typically don’t have to be explicit with what the result of <code>get</code> needs to be. We’ve been mostly explicit up until now as we wanted to pattern match, but the <code>PlayerComponent</code> is very simple.</p>
<p>Here is where I set my first <strong>challenge</strong> — this blog post is becoming way too long, and so I’m going to make a change and show you how cool the result is, and you’ll have to make the changes yourself! Of course, the repository can be found at the end of the section with a link to the commit, so if you get stuck you can look up how I managed it. These changes are small and numerous; too boring to put write up. Have fun and see you in the next section!</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- We are going to annotate each cell with the player who placed the cross</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Cell</span> <span class="ot">=</span> <span class="dt">Empty</span> <span class="op">|</span> <span class="dt">Filled</span> <span class="dt">PlayerComponent</span> <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- CHALLENGE:</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 1. Change colour of crosses to be dependent on player</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 2. Change circular 'aim' indicator to match player colour</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- 3. Have fun!</span></span></code></pre></div>
<div class="caption-frame apply-shadow">
<img src="https://res.cloudinary.com/aas-sh/image/upload/v1668977503/blog/2022/11/20-11-2022_20_51_32_keas6a.png" title="It's heating up; it's *red* vs *blue*!" class="w-full object-cover" alt="It's heating up; it's *red* vs *blue*!" />
<div class="caption">
<p>It’s heating up; it’s <em>red</em> vs <em>blue</em>!</p>
<div class="caption-source">
<a href="https://github.com/Ashe/Notakto/tree/f6b41756cf4f2e166d087b0b9c4487da6f996dff" title="Notakto">Notakto</a>
</div>
</div>
</div>
<div class="gitrepo infobox fill-horizontal">
<div class="header">
<span class="lab la-github mr-3"></span>Repository - Notakto
</div>
<p>A link to the final section can be found <a href="https://github.com/Ashe/Notakto/tree/f6b41756cf4f2e166d087b0b9c4487da6f996dff">here</a>.</p>
</div>
</section>
<section id="bonus-manually-implementing-first-person-camera" class="article-section">
<h2><span>Bonus: Manually implementing first-person camera</span><a href="#bonus-manually-implementing-first-person-camera" class="anchor las la-link" title="bonus-manually-implementing-first-person-camera"></a></h2>
<p>Okay, so I’ve spied online that this post is actually being read and people are posting it around on Reddit (thankyou!). With that in mind, I thought I’d update the repository so that newer Haskellers can use the code without as many issues. One of the biggest things I found is that the camera was no longer moving on its own.</p>
<p>This was actually something that worried me when using Raylib at first, as it felt too ‘magical’ that their demo just baked in the first person camera movement. Fortunately, this isn’t hard to do, and so here’s the code:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Had to update this system to return the window we create</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Also note that we disable the cursor straight away for free look</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ot">initialise ::</span> <span class="dt">System</span> <span class="dt">World</span> <span class="dt">RL.WindowResources</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>initialise <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> camera <span class="ot">=</span> <span class="dt">RL.Camera3D</span> (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">6</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) (<span class="dt">Vector3</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>) <span class="dv">90</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">RL.CameraPerspective</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  set global (<span class="dt">Camera</span> camera, <span class="dt">Red</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  newGame</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    window <span class="ot">&lt;-</span> RL.initWindow <span class="dv">1920</span> <span class="dv">1080</span> <span class="st">&quot;App&quot;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    RL.setTargetFPS <span class="dv">60</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    RL.disableCursor</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> window</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Also changed terminate to close the specific window we created</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="ot">terminate ::</span> <span class="dt">RL.WindowResources</span> <span class="ot">-&gt;</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>terminate window <span class="ot">=</span> liftIO <span class="op">$</span> RL.closeWindow window</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- We now manually manipulate the camera's location and rotation</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="ot">updateCamera ::</span> <span class="dt">System</span> <span class="dt">World</span> ()</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>updateCamera <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Camera</span> c <span class="ot">&lt;-</span> get global</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  newCam <span class="ot">&lt;-</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> RL.getFrameTime</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    forward <span class="ot">&lt;-</span> checkKey <span class="dt">RL.KeyW</span> <span class="dt">RL.KeyUp</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> checkKey <span class="dt">RL.KeyA</span> <span class="dt">RL.KeyLeft</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    backward <span class="ot">&lt;-</span> checkKey <span class="dt">RL.KeyS</span> <span class="dt">RL.KeyDown</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> checkKey <span class="dt">RL.KeyD</span> <span class="dt">RL.KeyRight</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Vector2</span> i j <span class="ot">&lt;-</span> RL.getMouseDelta</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> speed <span class="ot">=</span> <span class="fl">5.0</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        turnspeed <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Vector3</span> x _ z <span class="ot">=</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>          (RL.getCameraForward c <span class="op">|*</span> (forward <span class="op">-</span> backward)) <span class="op">|+|</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>          (RL.getCameraRight c <span class="op">|*</span> (right <span class="op">-</span> left))</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>        c' <span class="ot">=</span> RL.cameraMove c <span class="op">$</span> safeNormalize (<span class="dt">Vector3</span> x <span class="dv">0</span> z) <span class="op">|*</span> (speed <span class="op">*</span> dt)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>        c'' <span class="ot">=</span> RL.cameraYaw c' (<span class="op">-</span>i <span class="op">*</span> turnspeed <span class="op">*</span> dt) <span class="dt">False</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> RL.cameraPitch c'' (<span class="op">-</span>j <span class="op">*</span> turnspeed <span class="op">*</span> dt) <span class="dt">False</span> <span class="dt">False</span> <span class="dt">False</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  set global <span class="op">$</span> <span class="dt">Camera</span> newCam</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> checkKey a b <span class="ot">=</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>          liftA2 (\x y <span class="ot">-&gt;</span> <span class="kw">if</span> x <span class="op">||</span> y <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span>) (RL.isKeyDown a) (RL.isKeyDown b)</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>        safeNormalize v</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> magnitude v <span class="op">==</span> <span class="dv">0</span> <span class="ot">=</span> v</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>          <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> vectorNormalize v</span></code></pre></div>
<p>Some things to note here is that a lot of our vector math functions are <a href="https://hackage.haskell.org/package/h-raylib-4.6.0.6/docs/Raylib-Util-Math.html#g:3">built into the h-raylib bindings</a> now, so <code>|+|</code> lets you add two vectors together, <code>|*|</code> lets you multiply two vectors together, <code>|*</code> lets you multiply a vector with a normal scalar value and so on.</p>
<p>So with that in mind, we now retrieve the state of several keyboard inputs one by one and determine which direction we want to move in by combining the player’s net input as well as the camera’s forward and right directions. We then normalize that (I had to make a <code>safeNormalize</code> function for cases when magnituded is zero, this will probably get fixed soon) and multiply it by some speed value and delta time to make it frame independent. Looking around is similar; Raylib already gives us the mouse delta so we can put the right into the look direction logic.</p>
<p>Make sure to check out <a href="https://github.com/Ashe/Notakto/commit/dc35e711dbc48703ff827dedbd2969c54e826d48">the diff</a> for all the changes I made in this update. I hope this helps!</p>
</section>
</section>
<section id="wrapping-up" class="article-section">
<h1><span>Wrapping up</span><a href="#wrapping-up" class="anchor las la-link" title="wrapping-up"></a></h1>
<p><strong>Congratulations!</strong> I’m hoping that the content of this post, although long, has been useful as a gateway into the world of Haskell game development. I really enjoyed making this post and I’m hoping my readers enjoyed this new format even if it is a little wordy.</p>
<p>There are no more sections for this blog post, although honestly I wanted to go wild and do things like:</p>
<ul>
<li><p><strong>Projectiles:</strong> When you click, you shoot a cube and you have to land it in a cell for it to mark. Would be interesting to make it so that you can only shoot if no projectile currently exists, and making the actions that happen when you click the mouse delayed until the projectile lands. Good luck finding that shot when it goes out of bounds!</p></li>
<li><p><strong>Moving boards:</strong> We have a <code>PositionComponent</code> but the data never really changes once created. Wouldn’t it be fun to make the boards fly around?</p></li>
<li><p><strong>Rotated boards:</strong> Right now we assume all boards face the same way. Adding a rotation would be fun but a little bit of work since you may need to write your own vector math functions unless you use another library (I wanted the dependency count to be low for this post).</p></li>
<li><p><strong>Forced distance:</strong> I wanted to make it so that you could only take a turn if you were stood in an area, so that you had to aim. Would be cool making a little environment with player colouring!</p></li>
<li><p><strong>AI:</strong> Here’s an easy peasy one — make it so that when you make your move, you can get an AI to play as the other person! Start off by just randomising the entity and cell index, and once you you’ve got a very basic AI you can move up to implementing the <a href="https://en.wikipedia.org/wiki/Negamax">Negamax algorithm</a>!</p></li>
</ul>
<p>These things all sound fun, but I believe that the important thing is to teach the basics of Apecs and Raylib so that we get more projects popping up in the Haskell gamedev space. I’ve seen a lot of cool projects like <a href="https://hackage.haskell.org/package/keid-core">Keid</a>, but admittedly I just love Apecs too much, and now I can love Raylib also (even if I haven’t explored its limits too much).</p>
<p><strong><em>Big thankyous</em></strong> to:</p>
<ul>
<li><a href="https://jonascarpay.com/">Jonas Carpay</a>, author of <a href="https://hackage.haskell.org/package/apecs">Apecs</a>,</li>
<li><a href="https://github.com/Anut-py">Anand Swaroop (Anut-py)</a> for creating the <a href="https://hackage.haskell.org/package/h-raylib">h-raylib bindings</a>,</li>
<li>the authors of <a href="https://www.raylib.com/">Raylib</a>,</li>
<li>and finally, the <a href="https://nixos.org/community/">Nix community</a> for helping me with all my problems whenever I go crying to them about something not working. Really, thanks guys!</li>
</ul>
<p>If anyone wants anything from this blog revised, has feedback, or just wants to talk, you can get in touch via <a href="mailto:contact@aas.sh">contact@aas.sh</a>. Looking forward to hearing from you!</p>
<p>And with that, I’m signing off. Thank you for reading!</p>
</section>
          </div>
        </div>
      </article>
    </div>

  </div>
</div>

</section>



<div id="post-links">
  <div class="columns is-desktop">

    <div class="column left">
      
        
          <div class="post-link apply-shadow hover">
            <div class="w-full is-flex is-flex-direction-row">
              <img src="https://res.cloudinary.com/aas-sh/image/upload/v1658332892/blog/2022/07/sunrise_qo1y8n.jpg">
              <div class="link-info p-3 w-full">
                <small class="is-uppercase is-size-7 is-sans-serif">Previous Post</small>
                <h5 class="title is-5 m-0"><a href="../../blog/laplaces-rule-of-succession/" class="no-underline">Laplace's rule of succession</a></h3>
                <h6 class="subtitle is-6">A post on one of my favourite mathematical theorems.</h6>
              </div>
            </div>
          </div>
        
      
    </div>

    <div class="column right">
      
        
          <div class="post-link apply-shadow hover">
            <div class="w-full is-flex is-flex-direction-row">
              <div class="link-info p-3 w-full">
                <small class="is-uppercase is-size-7 is-sans-serif">Next Post</small>
                <h5 class="title is-5 m-0"><a href="../../blog/burnout/" class="no-underline">I'm burned out</a></h3>
                <h6 class="subtitle is-6">An update on my life situation.</h6>
              </div>
              <img src="https://res.cloudinary.com/aas-sh/image/upload/v1708714543/blog/2024/02/burnout_yrshla.png">
            </div>
          </div>
        
      
    </div>

  </div>
</div>

    </main>

    <footer>
  <div class="container is-max-desktop">
    <div class="columns">

      <div class="column">
        <h3 class="title is-5">Contact</h3>
        <ul class="ml-1 ">
          <li>
            <a href="mailto:contact@aas.sh" class="no-underline">
              <i class="las la-envelope-open-text"></i> contact@aas.sh
            </a>
          </li>
          <li>
            <a href="https://github.com/ashe" class="no-underline">
              <i class="lab la-github"></i> github.com/ashe
            </a>
          </li>
          <li>
            <a href="https://linkedin.com/in/itsashe" class="no-underline">
              <i class="lab la-linkedin"></i></svg> linkedin.com/in/itsashe
            </a>
          </li>
        </ul>
      </div>

      <div class="column">
        <h3 class="title is-5">About this blog</h3>
        <ul class="ml-1">
          <li>
            Built with <i class="las la-code"></i> and <i class="lar la-heart"></i> using <a href="https://jaspervdj.be/hakyll/">Hakyll</a>
          </li>
          <li id="git-hash">
            <i class="las la-code-branch"></i> 
            Last updated: 
            <a href="https://github.com/ashe/ashe.github.io">871ce24: Updated swiper sha (2024-07-27 09:40:18 +0100)</a>
          </li>
          <li>
            <a href="https://builtwithnix.org" rel="nofollow">
              <img src="https://builtwithnix.org/badge.svg" alt="Built with Nix">
            </a>
          </li>
        </ul>
      </div>

      <div id="footer-logo" class="column">
        <a href="../../">
          <img src="../../assets/images/logo.png" alt="Aas.sh site logo">
        </a>
      </div>

    </div>
  </div>
</footer>


    <script src="../../assets/scripts/darkmode.js"></script>
    <script src="../../assets/scripts/navbar-menu.js"></script>
    <script src="../../assets/scripts/navbar-toc.js"></script>
    <link rel="stylesheet" href="../../assets/thirdparty/katex/katex.min.css">
    <script defer src="../../assets/thirdparty/katex/katex.min.js"></script>
    <script type="text/javascript" script defer src="../../assets/thirdparty/katex/contrib/auto-render.min.js" onload="renderMathInElement(document.body);">
    </script>

    
      <script src="../../assets/thirdparty/vanillajs-scrollspy/vanillajs-scrollspy.min.js"></script>
      <script src="../../assets/scripts/init-scrollspy.js"></script>
    
  </body>

</html>
